# јрхитектура системы событий DialogueSystem

## ?? ќбзор потока событий

```
???????????????????????????????????????????????????????????????????????????
?       DIALOGUE SYSTEM EVENT FLOW        ?
???????????????????????????????????????????????????????????????????????????

      ????????????????????
    ?  Player Action   ?
           ? (Press E to talk)?
       ????????????????????
   ?
        ?
        ???????????????????????????
    ?  DialogueComponent      ?
           ?StartDialogue()  ?
     ???????????????????????????
   ?
     ?
          ?????????????????????????????
          ?   DialogueSubsystem       ?
              ?   StartDialogue()         ?
     ?????????????????????????????
         ?
     ???????????????????????????
               ?           ?
            ? ?
    ????????????????????   ????????????????????????
    ?  DialogueRunner  ?      ?  Broadcast Global:   ?
    ?  StartDialogue() ?      ?  OnAnyDialogueStarted?
    ????????????????????      ????????????????????????
  ?       ?
      ??? OnDialogueStarted ??????? Player
             ?   (Local Event)         ?
  ?           ??? UI Manager
             ?  ?
    First Node Entered  ??? Achievement System
      ?
   ?
    ??????????????????????????
    ?  OnNodeEntered (Runner)?
  ??????????????????????????
     ?
    ???????????????????????????????????????????
    ?          ?
    ?   ?
??????????????????????????     ????????????????????????????????
? DialogueComponent      ?     ? DialogueSubsystem?
? OnDialogueNodeChanged  ?     ? OnAnyDialogueNodeChanged     ?
? (Local Event)       ?     ? (Global Event)        ?
??????????????????????????     ????????????????????????????????
 ?          ?
         ??? NPC Animation         ??? Player (Subtitles)
         ??? Voice Playback     ??? UI (Update Text)
??? Camera Effects             ??? Audio Manager
             
     ...User makes choices...
             
         ?
             ?
    ??????????????????????????
    ?  Dialogue Ends         ?
  ?  EndDialogue()  ?
    ??????????????????????????
        ?
    ????????????????????????????????????????
    ?            ?
    ? ?
??????????????????????????     ?????????????????????????????
? DialogueRunner         ? ? DialogueSubsystem         ?
? OnDialogueEnded        ?     ? OnAnyDialogueEnded        ?
? (Runner Event)         ?     ? (Global Event)        ?
??????????????????????????     ?????????????????????????????
         ?       ?
  ?             ?
??????????????????????????     ????????????????????????????
? DialogueComponent   ?     ? Player?
? OnDialogueEnded        ?     ? Х Enable Input   ?
? (Local Event)          ?     ? Х Hide UI    ?
??????????????????????????   ? Х Save Progress          ?
         ?         ????????????????????????????
  ?
     NPC Returns to Idle
```

---

## ?? ƒва уровн€ событий

### 1. Ћокальные событи€ (DialogueComponent)
ѕрив€заны к конкретному NPC. »спользуйте дл€:
- јнимации NPC
- —пецифичной логики персонажа
- AI поведени€

```
DialogueComponent (NPC_Guard)
    ?
    ??? OnDialogueStarted ??? Play Animation "Talking"
    ??? OnDialogueEnded ??? Play Animation "Idle"
    ??? OnDialogueNodeChanged ??? Update Facial Expression
```

### 2. √лобальные событи€ (DialogueSubsystem)
Ћов€т ¬—≈ диалоги в игре. »спользуйте дл€:
- ”правлени€ игроком
- UI системы
- √лобальных менеджеров

```
DialogueSubsystem (Global)
    ?
    ??? OnAnyDialogueStarted
    ?   ??? Player: Disable Movement
    ?   ??? UI Manager: Show Dialogue UI
    ?   ??? Audio Manager: Lower Background Music
    ?
    ??? OnAnyDialogueEnded
    ?   ??? Player: Enable Movement
    ?   ??? UI Manager: Hide Dialogue UI
    ?   ??? Achievement System: Track Completion
    ?   ??? Audio Manager: Restore Background Music
    ?
  ??? OnAnyDialogueNodeChanged
        ??? Player: Update Subtitles
     ??? UI Manager: Show Speaker Name
        ??? Audio Manager: Play Voice Line
```

---

## ???  омпонентна€ архитектура

```
??????????????????????????????????????????????????????????????????????????
?      GAME WORLD         ?
??????????????????????????????????????????????????????????????????????????
?     ?
?  ????????????????        ????????????????        ????????????????    ?
?  ?NPC #1  ?        ?   NPC #2     ?        ?   NPC #3     ?    ?
?  ????????????????     ????????????????        ????????????????    ?
?  ? Dialogue     ?  ? Dialogue     ?        ? Dialogue     ?    ?
?  ? Component    ?        ? Component    ?        ? Component    ?    ?
?  ?              ?   ?      ?        ?    ?    ?
?  ? Х OnDialogue ?        ? Х OnDialogue ?        ? Х OnDialogue ?    ?
?  ?   Started    ?        ?   Started    ?        ?   Started    ?    ?
?  ? Х OnDialogue ?        ? Х OnDialogue ?        ? Х OnDialogue ?    ?
?  ?   Ended?        ?   Ended      ?        ?   Ended      ?    ?
?  ? Х OnNode     ?        ? Х OnNode     ? ? Х OnNode     ?    ?
?  ?   Changed    ?        ?   Changed    ?        ?   Changed    ?    ?
?  ????????????????        ????????????????        ????????????????    ?
?         ?       ?      ?      ?
?         ?????????????????????????????????????????????????          ?
?         ?             ?
?             ?     ?
? ????????????????????????????      ?
?     ?  DialogueSubsystem       ?          ?
?      ?  (Game Instance Level)?         ?
?????????????????????????????           ?
?        ? GLOBAL EVENTS:     ?         ?
?          ? Х OnAnyDialogueStarted   ?        ?
?           ? Х OnAnyDialogueEnded     ?      ?
?         ? Х OnAnyDialogueNodeChanged           ?
?       ????????????????????????????            ?
?  ?    ?
?    ???????????????????????????????????????????????    ?
?         ?         ?           ?     ?
?  ?          ?    ?           ?
?  ???????????????        ???????????????      ???????????????      ?
?  ?   Player ?        ? UI Manager  ?      ? Achievement ?      ?
?  ? Controller  ?        ?         ?      ?   System    ?      ?
?  ???????????????        ???????????????      ???????????????      ?
?  ? Listens to: ?  ? Listens to: ?      ? Listens to: ?      ?
?? Х Started   ?? Х Started   ?      ? Х Ended     ?      ?
?  ? Х Ended     ?        ? Х Ended     ?      ?        ?      ?
?  ? Х Changed   ?        ? Х Changed   ?      ?        ?      ?
?  ???????????????  ??????????????? ???????????????      ?
?     ?
???????????????????????????????????????????????????????????????????????
```

---

## ?? ∆изненный цикл событи€

### ќт действи€ игрока до обработки

```
1. INITIATION
   Player presses E ? Interaction Component ? DialogueComponent.StartDialogue()

2. SERVICE LAYER
   DialogueComponent ? DialogueSubsystem.StartDialogue()

3. RUNNER CREATION
   Subsystem creates/acquires DialogueRunner from pool

4. EVENT BROADCASTING - STARTED
   ??? DialogueRunner.OnDialogueStarted (to Component)
   ?   ??? DialogueComponent.OnDialogueStarted (local event)
   ?     ??? Listeners: NPC animations, AI
   ?
   ??? DialogueSubsystem.OnAnyDialogueStarted (global event)
       ??? Listeners: Player, UI, Audio, Achievements

5. DIALOGUE EXECUTION
   ??? First node entered
   ?   ??? DialogueRunner.OnNodeEntered
   ?   ?   ??? DialogueComponent.OnDialogueNodeChanged
   ?   ?   ??? DialogueSubsystem.OnAnyDialogueNodeChanged
   ?   ?
   ?   ??? Listeners process new node (voice, text, animation)
   ?
   ??? User makes choice
   ?   ??? Repeat node processing
   ?
   ??? Continue until end node

6. EVENT BROADCASTING - ENDED
   ??? DialogueRunner.OnDialogueEnded (to Component)
   ?   ??? DialogueComponent.OnDialogueEnded (local event)
   ?       ??? Listeners: NPC returns to idle
   ?
   ??? DialogueSubsystem.OnAnyDialogueEnded (global event)
       ??? Listeners: Player regains control, UI hides, stats saved

7. CLEANUP
   Runner returned to pool, references cleared
```

---

## ?? ѕримеры интеграции

### ѕример 1: ”правление Player Input

```
??????????????????????????????????????????????
?          Player Character BP     ?
??????????????????????????????????????????????
?              ?
?  Event BeginPlay               ?
?      ?          ?
?    ?      ?
?  Get DialogueSubsystem           ?
?      ?     ?
?      ???? Bind: OnAnyDialogueStarted       ?
?      ?    ?              ?
?      ?    ???? Custom: OnGlobalDialogueStart?
?      ?         ?? Check: Player == Self     ?
?      ?         ?? Disable Input   ?
?      ?      ?
? ???? Bind: OnAnyDialogueEnded         ?
?    ?         ?
?     ???? Custom: OnGlobalDialogueEnd  ?
?       ?? Check: Player == Self ?
?          ?? Enable Input      ?
?   ?
??????????????????????????????????????????????
```

### ѕример 2: UI Manager

```
??????????????????????????????????????????????
?          UI Manager Component               ?
??????????????????????????????????????????????
?       ?
?  Subscribe to Global Events:          ?
?   ?
?  OnAnyDialogueStarted       ?
?      ??? Create Dialogue Widget            ?
?      ??? Add to Viewport      ?
???? Store Runner reference    ?
?               ?
?  OnAnyDialogueNodeChanged        ?
? ??? Get dialogue text from NewNode    ?
?      ??? Get speaker name           ?
?      ??? Update UI labels   ?
?   ?
?  OnAnyDialogueEnded      ?
?      ??? Remove widget from viewport       ?
?      ??? Clear references      ?
?         ?
??????????????????????????????????????????????
```

### ѕример 3: Audio Manager

```
??????????????????????????????????????????????
?          Audio Manager Subsystem      ?
??????????????????????????????????????????????
?   ?
?  Subscribe to Global Events:          ?
?        ?
?  OnAnyDialogueStarted         ?
?      ??? Lower background music volume     ?
?     ?
?  OnAnyDialogueNodeChanged          ?
?  ??? Stop previous voice line          ?
? ??? Check if NewNode has VoiceClip    ?
?      ??? Play Sound 2D               ?
?         ?
?  OnAnyDialogueEnded                 ?
?      ??? Restore background music volume   ?
?        ?
??????????????????????????????????????????????
```

### ѕример 4: Achievement System

```
??????????????????????????????????????????????
?       Achievement Manager Component         ?
??????????????????????????????????????????????
?           ?
?  Subscribe to:   ?
?             ?
?  OnAnyDialogueEnded           ?
?      ??? Increment: TotalDialoguesCount    ?
?      ??? Check achievement thresholds?
?      ?    ?? 10 dialogues ? "Chatty"       ?
?      ?    ?? 50 dialogues ? "Conversationalist"?
?    ?    ?? 100 dialogues ? "Social Butterfly"?
?      ?        ?
?      ??? Track specific NPC interactions   ?
?           ?? All NPCs talked to ? "Friendly"?
?     ?
??????????????????????????????????????????????
```

---

## ?? Performance Considerations

### Event Broadcasting Performance

```
Single Dialogue Started
    ?
    ??? Local Event (DialogueComponent)
    ?   ??? ~1-5 listeners (typically just NPC)
    ?
    ??? Global Event (DialogueSubsystem)
        ??? ~3-10 listeners (Player, UI, Audio, etc.)

Total: ~4-15 function calls per event
Performance: O(n) where n = number of listeners
Impact: Negligible (< 0.1ms on modern hardware)
```

### Memory Usage

```
Per NPC:
    Х DialogueComponent: ~200 bytes
    Х Event bindings: ~50 bytes per listener
    
Global (Subsystem):
    Х 3 multicast delegates: ~100 bytes each
    Х Active dialogue tracking: ~50 bytes

Total Overhead: < 1KB per NPC + ~400 bytes global
```

### Best Practices

? **DO:**
- Use global events for player/UI/managers
- Use local events for NPC-specific logic
- Unbind events in EndPlay (local) or when no longer needed
- Check `Player == Self` in multiplayer

? **DON'T:**
- Subscribe/unsubscribe in Tick
- Store long-lived references to Runner or Nodes
- Perform heavy computations in event handlers
- Forget to check IsValid() for optional data

---

## ?? —в€занные документы

- [Player Dialogue Events Guide](07_Player_Dialogue_Events_Guide.md) - ѕодробное руководство дл€ игрока
- [Dialogue Events Guide](06_DialogueEvents_Guide.md) - ќбща€ документаци€ по событи€м
- [Quick Reference](Player_Events_QuickRef.md) - Ѕыстра€ справка

---

**¬ерси€:** 1.1.0  
**ƒата:** 22.01.2025  
**јвтор:** DialogueSystem Team

# Quick Reference: Dialogue Events из Player Blueprint

## ? Самый простой способ (Рекомендуется)

### 1. В BeginPlay игрока:

```
Event BeginPlay
    ?
Get Game Instance
?
Get Subsystem (DialogueSubsystem)
    ?
Store in Variable: "DialogueSubsystem"
```

### 2. Подписаться на события:

```
DialogueSubsystem
    ?
   ??? Bind: On Any Dialogue Started ??? HandleDialogueStart
    ??? Bind: On Any Dialogue Ended ??? HandleDialogueEnd
    ??? Bind: On Any Dialogue Node Changed ??? HandleNodeChange
```

### 3. Создать обработчики:

#### HandleDialogueStart (Runner, Player, NPC)
```
Branch: Player == Self?
    ??? TRUE
    ?   ?? Disable Input
    ?   ?? Show UI
    ?   ?? Store Runner
    ??? FALSE (ignore - другой игрок)
```

#### HandleDialogueEnd (Player, NPC)
```
Branch: Player == Self?
    ??? TRUE
    ?   ?? Enable Input
    ?   ?? Hide UI
    ?   ?? Clear Runner
    ??? FALSE (ignore)
```

#### HandleNodeChange (NewNode, PreviousNode, Runner)
```
Is Valid (NewNode)?
    ??? TRUE
    ?   ?? Get Dialogue Text
    ?   ?? Update UI
    ?   ?? Play Voice (if exists)
    ??? FALSE (ignore)
```

---

## ?? События DialogueSubsystem

| Событие | Параметры | Когда срабатывает |
|---------|-----------|-------------------|
| **OnAnyDialogueStarted** | Runner, Player, NPC | Любой диалог начался |
| **OnAnyDialogueEnded** | Player, NPC | Любой диалог закончился |
| **OnAnyDialogueNodeChanged** | NewNode, PreviousNode, Runner | Любая реплика сменилась |

---

## ?? Типичные задачи

### Задача 1: Отключить управление во время диалога

```
On Any Dialogue Started:
    Branch: Player == Self
        ??? Get Player Controller
      ??? Disable Input

On Any Dialogue Ended:
    Branch: Player == Self
 ??? Get Player Controller
        ??? Enable Input
```

### Задача 2: Показать UI диалога

```
On Any Dialogue Started:
    Branch: Player == Self
      ??? Create Widget (WBP_DialogueUI)
        ??? Add to Viewport
        ??? Store in: CurrentDialogueWidget

On Any Dialogue Ended:
    Branch: Player == Self
        ??? Get: CurrentDialogueWidget
        ??? Is Valid? ??? Remove from Parent
        ??? Clear: CurrentDialogueWidget
```

### Задача 3: Воспроизвести озвучку

```
On Any Dialogue Node Changed:
    Is Valid (NewNode)?
    ??? Get: NewNode.VoiceClip
        ??? Is Valid (VoiceClip)?
        ?   ??? Play Sound 2D
 ??? (no voice)
```

### Задача 4: Показать субтитры

```
On Any Dialogue Node Changed:
    Is Valid (NewNode)?
     ??? Get Dialogue Text
        ??? Get Speaker Name
    ??? Update Subtitle Widget
??? Start Fade Out Timer (3s)
```

---

## ?? ВАЖНО: Проверяйте Player == Self!

В глобальных событиях **ВСЕГДА** проверяйте:

```
Branch: Player == Self
    ??? TRUE ??? Обработать событие
    ??? FALSE ??? RETURN (игнорировать)
```

Иначе в мультиплеере события будут срабатывать для всех игроков!

---

## ?? Если не работает

### Событие не срабатывает?
1. ? Subsystem получен? (`Get Game Instance` ? `Get Subsystem`)
2. ? Событие подписано? (`Bind Event to...`)
3. ? Подписка в BeginPlay? (не в Tick!)
4. ? Диалог запускается? (проверьте NPC)

### UI не появляется?
1. ? Widget создан? (`Create Widget`)
2. ? Widget добавлен? (`Add to Viewport`)
3. ? Проверка `Player == Self`?
4. ? `Print String` для отладки?

### Crash при смене ноды?
1. ? Проверка `Is Valid (NewNode)`?
2. ? Проверка `Is Valid (VoiceClip)`?
3. ? Widget существует?

---

## ?? Граф для Copy-Paste

### Минимальный рабочий граф:

```
????????????????????????????????????????????????????????????
?         Event BeginPlay (Player)    ?
????????????????????????????????????????????????????????????
?  Get Game Instance           ?
?    ?        ?
?  Get Subsystem (DialogueSubsystem)         ?
?      ?     ?
?  Store: CachedSubsystem         ?
?      ?          ?
?  Bind: On Any Dialogue Started ??? OnDialogueStart      ?
?  Bind: On Any Dialogue Ended ??? OnDialogueEnd       ?
?  Bind: On Any Dialogue Node Changed ??? OnNodeChange    ?
????????????????????????????????????????????????????????????

????????????????????????????????????????????????????????????
?    Custom Event: OnDialogueStart (Runner, Player, NPC)  ?
????????????????????????????????????????????????????????????
?  Branch: Player == Self  ?
?      ?? TRUE          ?
?      ?   ?? Get Player Controller         ?
?      ?   ?   ?? Disable Input          ?
?      ?   ?? Create Widget: WBP_DialogueUI         ?
?      ?   ?   ?? Add to Viewport            ?
?      ?   ?   ?? Store: CurrentWidget         ?
? ?   ?? Print: "Dialogue Started!"      ?
?      ?? FALSE ??? RETURN           ?
????????????????????????????????????????????????????????????

????????????????????????????????????????????????????????????
?Custom Event: OnDialogueEnd (Player, NPC)         ?
????????????????????????????????????????????????????????????
?  Branch: Player == Self        ?
?      ?? TRUE     ?
?      ?   ?? Get Player Controller  ?
?      ?   ?   ?? Enable Input         ?
?   ?   ?? Get: CurrentWidget        ?
?      ?   ?   ?? Is Valid?          ?
?   ?   ?   ?? Remove from Parent       ?
?      ?   ?? Print: "Dialogue Ended!"        ?
?      ?? FALSE ??? RETURN           ?
????????????????????????????????????????????????????????????

????????????????????????????????????????????????????????????
? Custom Event: OnNodeChange (NewNode, PreviousNode, ...) ?
????????????????????????????????????????????????????????????
?  Is Valid (NewNode)?   ?
?      ?? TRUE     ?
?      ?   ?? Get Dialogue Text ?
?      ?   ?? Get: CurrentWidget      ?
?      ?   ?   ?? Update Text Display      ?
?      ?   ?? Get: NewNode.VoiceClip     ?
?      ?   ?   ?? Is Valid?    ?
?      ?   ?   ?? Play Sound 2D           ?
?      ?   ?? Print: "Node changed"  ?
?      ?? FALSE ??? RETURN        ?
????????????????????????????????????????????????????????????
```

---

## ?? Полная документация

- [Полное руководство для игрока](07_Player_Dialogue_Events_Guide.md)
- [Общее руководство по событиям](06_DialogueEvents_Guide.md)
- [Быстрый старт](06_DialogueEvents_QuickStart.md)
- [Шпаргалка](DialogueEvents_CheatSheet.md)

---

**Версия:** 1.1.0  
**Дата:** 22.01.2025

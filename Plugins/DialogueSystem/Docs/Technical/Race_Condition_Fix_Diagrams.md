# Race Condition Fix - Visual Diagrams

> **Version:** 1.1.1  
> **Purpose:** Визуальное представление проблемы и решения

---

## ?? Sequence Diagram

### ? До исправления (v1.1.0) - Race Condition

```
??????????????        ????????????????????     ??????????????????
?   Caller   ?        ? DialogueSubsystem?         ? StreamableManager?
??????????????        ????????????????????      ???????????????????
      ?      ?             ?
      ? LoadDialogueAsync()    ?        ?
      ????????????????????????>?      ?
      ?             ?              ?
    ?   ?  1. Create LoadInfo        ?
      ?          ?    (local variable)        ?
?               ?    ?
    ?    ?  2. RequestAsyncLoad()     ?
      ?    ????????????????????????????>?
   ?                ? ?
      ?    ?        ?  ?? If asset in memory
 ?             ??     callback fires NOW!
?             ?  ?? Callback fires    ?
      ? ?<????????????????????????????
      ?          ?       ?
      ?   ?  3. OnAsyncLoadCompleted() ?
      ?       ?     Looks in map...        ?
      ? ?     ? NOT FOUND!      ?
      ?               ?      ?
      ?  ?  4. Add to PendingAsyncLoads?
      ?               ?   (TOO LATE!)    ?
      ?           ?     ?
      ?  ? Callback never   ?           ?
      ?     executes!  ?           ?
  ?<???????????????????????? ?
      ?        ?   ?
```

### ? После исправления (v1.1.1) - Thread-Safe

```
??????????????        ????????????????????         ??????????????????
?   Caller   ?   ? DialogueSubsystem?   ? StreamableManager?
??????????????        ????????????????????    ???????????????????
      ?         ?    ?
      ? LoadDialogueAsync()    ?     ?
      ????????????????????????>?    ?
      ?       ?        ?
      ?      ?  1. Create LoadInfo        ?
      ? ?    (local variable)     ?
      ?      ?   ?
 ?         ?  2. ? Add to PendingAsyncLoads?
      ?            ?     BEFORE async operation ?
      ?        ?     ?
      ?          ?  3. Get reference:   ?
      ??     FAsyncLoadInfo& ref    ?
      ?                ?         ?
      ?    ?  4. RequestAsyncLoad()     ?
      ?       ????????????????????????????>?
      ?   ?              ?
      ?      ?               ?  ? If asset in memory
      ?             ?          ?  callback fires NOW
      ?         ?  ? Callback fires          ?
      ?     ?<????????????????????????????
   ??                  ?
      ?    ?  5. OnAsyncLoadCompleted() ?
      ??     Looks in map...        ?
      ?      ?     ? FOUND!         ?
      ?            ?     Callbacks execute      ?
      ?    ?             ?
      ?  ? Callback executes   ?       ?
      ?   successfully!      ?             ?
      ?<????????????????????????   ?
      ?           ?           ?
```

---

## ?? State Diagram

### ? До исправления - Broken State Flow

```
        LoadDialogueAsync()
     ?
         ?
   ???????????????????
              ? Create LoadInfo ?
   ?  (Local var)    ?
           ???????????????????
      ?
         ?
      ????????????????????????????
? RequestAsyncLoad()       ?
?     ?
              ? ?? If asset in memory:   ?
       ?    Callback fires NOW    ?
          ????????????????????????????
    ?
             ???????????????????
        ?       ?
       ?           ?
    [Async Path]            [Sync Path]
      ?
   ?
                  ????????????????????????????
       ? OnAsyncLoadCompleted()   ?
         ? Searches PendingAsyncLoads?
    ? ? NOT FOUND (empty!)     ?
               ????????????????????????????
     ?
     ?
          ????????????????????????????
       ? Add LoadInfo to map      ?
    ? (TOO LATE!)       ?
        ????????????????????????????
       ?
      ?
   ? User hangs forever
```

### ? После исправления - Correct State Flow

```
         LoadDialogueAsync()
  ?
     ?
     ???????????????????
    ? Create LoadInfo ?
       ?  (Local var)    ?
  ???????????????????
        ?
        ?
       ????????????????????????????
   ? ? Add to map FIRST      ?
              ? Get reference: ref  ?
              ????????????????????????????
   ?
         ?
  ????????????????????????????
         ? RequestAsyncLoad()       ?
        ?           ?
   ? ? Safe: LoadInfo in map ?
    ????????????????????????????
            ?
  ???????????????????
          ?       ?
                ??
    [Async Path]   [Sync Path]
              ?
    ?
              ????????????????????????????
                    ? OnAsyncLoadCompleted()   ?
  ? Searches PendingAsyncLoads?
          ? ? FOUND!      ?
      ????????????????????????????
        ?
               ?
          ????????????????????????????
         ? Execute all callbacks    ?
           ? Clean up LoadInfo        ?
         ????????????????????????????
    ?
        ?
   ? User receives data
```

---

## ?? Memory Layout Diagram

### ? До исправления - Race Condition

```
Timeline:  ??????????????????????????????????????>

Stack:
??????????????????????????????
? LoadDialogueAsync()        ?
??
? LoadInfo (local) ?  ? Created
? ?? DialogueId  ?
? ?? AssetPath         ?
? ?? Callbacks           ?
??????????????????????????????

Heap (PendingAsyncLoads):
??????????????????????????????
? TMap<FName, FAsyncLoadInfo>?
?       ?
? [empty]    ?  ? Still empty!
?   ?
??????????????????????????????

  ?
    RequestAsyncLoad() fires
   ?
    Callback executes (sync)
    ?
 Looks in PendingAsyncLoads
         ?
            ? NOT FOUND
```

### ? После исправления - Thread-Safe

```
Timeline:  ??????????????????????????????????????>

Stack:
??????????????????????????????
? LoadDialogueAsync()        ?
?         ?
? LoadInfo (local)  ?  ? Created
? ?? DialogueId              ?
? ?? AssetPath           ?
? ?? Callbacks      ?
??????????????????????????????
          ?
         ? MoveTemp()
       ?
Heap (PendingAsyncLoads):
??????????????????????????????
? TMap<FName, FAsyncLoadInfo>?
?                 ?
? ["Dialogue1"] = LoadInfo   ?  ? Added FIRST
? ?? DialogueId    ?
? ?? AssetPath    ?
? ?? Callbacks       ?
? ?? StreamableHandle        ?  ? Set via reference
??????????????????????????????

Stack:
??????????????????????????????
? LoadDialogueAsync()        ?
?      ?
? LoadInfoRef (reference)    ?  ? Points to heap
?     ?      ?
? [Heap: PendingAsyncLoads]  ?
??????????????????????????????

      ?
    RequestAsyncLoad() fires
    ?
    Callback executes (sync)
           ?
    Looks in PendingAsyncLoads
      ?
            ? FOUND!
```

---

## ?? Timeline Comparison

### ? Broken Timeline (v1.1.0)

```
Time: 0ms  50ms      100ms
      ?      ?       ?
      ? Create LoadInfo  ?      ?
      ??????????????????>?   ?
      ?   ?     ?
 ? Start Async Load ?      ?
      ??????????????????>?         ?
      ?    ?     ?
    ?       ? ?? Callback NOW! ?
      ?                  ??????????????????>?
      ?     ?   ?
      ?       ?      ? Map empty ?
      ?                  ?<??????????????????
?        ?         ?
   ? Add to map       ?       ?
 ??????????????????>?   ?
      ?        ?          ?
    ?  ? Hang forever  ?       ?
      ?        ?      ?
```

### ? Fixed Timeline (v1.1.1)

```
Time: 0ms      50ms     100ms
    ?     ? ?
      ? Create LoadInfo  ?    ?
      ??????????????????>?        ?
      ?     ?      ?
      ? ? Add to map    ?      ?
   ??????????????????>?        ?
      ? ?      ?
      ? Start Async Load ?      ?
      ??????????????????>?     ?
      ?        ?   ?
      ?           ? ? Callback NOW! ?
      ???????????????????>?
      ?        ?     ?
      ?  ?    ? Found in map?
      ?   ?<??????????????????
      ?            ?       ?
   ?  ? Execute callbacks      ?
      ?<??????????????????  ?
      ?            ?      ?
      ?  ? Success!      ?       ?
      ?    ?    ?
```

---

## ?? Critical Path Analysis

### ? Before (Race Condition)

```
Critical Path (Happy Case):
LoadDialogueAsync ? Create LoadInfo ? RequestAsyncLoad ? (async) ? OnAsyncLoadCompleted ? Execute Callbacks
               
Critical Path (Broken Case):
LoadDialogueAsync ? Create LoadInfo ? RequestAsyncLoad ? (sync!) ? OnAsyncLoadCompleted ? ? Not found ? Hang
         ?
  Add to map (too late)
```

### ? After (Thread-Safe)

```
Critical Path (All Cases):
LoadDialogueAsync ? Create LoadInfo ? Add to map ? Get reference ? RequestAsyncLoad ? OnAsyncLoadCompleted ? Execute Callbacks
                ?       ?
      Always executed first              Always finds entry
```

---

## ?? Lock-Free Guarantees

### ? Before - No Guarantee

```
Thread: Game Thread
????????????????????????????????????????????????
?        ?
?  RequestAsyncLoad()       ?
?   ?     ?
?       ?? If asset loaded:     ?
?       ?     Execute callback ?????????       ?
?    ?     ?       ?
?       ?? If not loaded:               ?       ?
?       Schedule async ?????      ?   ?
?            ?      ?     ?
?  Add to PendingAsyncLoads  ?  ?       ?
?       ?     ?      ?       ?
?       ?            ?  ?       ?
?  ?? Race! Callback may         ?   ?     ?
?     execute before Add         ?      ?    ?
?          ?      ?     ?
?      [Undefined]         ?
????????????????????????????????????????????????
```

### ? After - Guaranteed Order

```
Thread: Game Thread
????????????????????????????????????????????????
?  ?
?  Add to PendingAsyncLoads (ALWAYS FIRST)     ?
?       ?   ?
?     ??????????????????????? ?
?     ?         ?
?  RequestAsyncLoad()     ?         ?
?       ? ?     ?
?   ?? If asset loaded:   ?                ?
?       ?     Execute callback??????????       ?
?       ?     (map has entry) ?        ?     ?
?       ?     ?        ?       ?
? ?? If not loaded:      ?        ?       ?
?Schedule async ????????   ?       ?
?           (map has entry)  ?    ?   ?       ?
?        ?    ?   ?       ?
?      ? Always safe       ?
????????????????????????????????????????????????
```

---

## ?? Code Flow Pseudocode

### ? Broken Flow

```
function LoadDialogueAsync(DialogueId, OnLoaded):
    // Step 1: Create info
    info = new LoadInfo()
    info.id = DialogueId
    info.callback = OnLoaded
  
    // Step 2: Start async (MAY BE SYNC!)
    handle = StreamableManager.Load(DialogueId, () => {
      // ?? This may execute NOW!
        found = PendingAsyncLoads.Find(DialogueId)
  if found:  // ? Will be false if sync!
          found.callback()
    })
    
    info.handle = handle
    
    // Step 3: Add to map (TOO LATE if callback already fired!)
    PendingAsyncLoads.Add(DialogueId, info)
```

### ? Fixed Flow

```
function LoadDialogueAsync(DialogueId, OnLoaded):
  // Step 1: Create info
    info = new LoadInfo()
    info.id = DialogueId
    info.callback = OnLoaded
    
    // Step 2: ? Add to map FIRST
    PendingAsyncLoads.Add(DialogueId, info)
    
    // Step 3: ? Get reference from map
    infoRef = PendingAsyncLoads.GetReference(DialogueId)
    
    // Step 4: Start async (safe if sync!)
    handle = StreamableManager.Load(DialogueId, () => {
        // ? This is safe even if sync!
        found = PendingAsyncLoads.Find(DialogueId)
        if found:  // ? Will always be true!
    found.callback()
    })
    
    // Step 5: Set handle via reference
    infoRef.handle = handle
```

---

## ?? Key Takeaways

### 1. Order Matters
```
? Start ? Add       (Race condition)
? Add ? Start       (Thread-safe)
```

### 2. References after MoveTemp
```
? Move ? Use original  (Undefined behavior)
? Move ? Get reference (Correct)
```

### 3. Async !== Always Async
```
Async API can be:
?? Truly async (scheduled)
?? Sync (executed immediately)
   ?? ?? Must be safe for both cases!
```

---

**Version:** 1.1.1  
**Date:** 22.01.2025  
**Status:** ? FIXED

# Quick Start: Отслеживание событий диалога в Blueprint

## ?? Цель
Научиться реагировать на события диалога (начало, конец, смена реплики) в Blueprint.

## ?? Шаги

### 1?? Настройка NPC Blueprint

1. Откройте Blueprint вашего NPC
2. Убедитесь что у него есть `Dialogue Component`
3. Перейдите в **Event Graph**

### 2?? Подписка на события

#### Способ A: Через Details панель (проще)

1. Выберите `Dialogue Component` в компонентах
2. В **Details** панели прокрутите до секции **Events**
3. Найдите и нажмите `+` рядом с:
   - **On Dialogue Started**
   - **On Dialogue Ended**  
   - **On Dialogue Node Changed**

#### Способ B: Вручную в Event Graph

```
Event BeginPlay
    ?
    ?
[Get Dialogue Component (Self)]
?
    ?
[Assign On Dialogue Started]
    ?
    ???? [Create Event: Handle Dialogue Started]
```

---

## ?? Практические примеры

### Пример 1: Отключить управление игрока во время диалога

```
?? On Dialogue Started (Dialogue Component) ??
?          ?
? Get Player Controller        ?
?         ?        ?
?         ?       ?
?   Disable Input      ?
?   ?
???????????????????????????????????????????????

?? On Dialogue Ended (Dialogue Component) ????
?         ?
?   Get Player Controller   ?
?         ?           ?
?         ?     ?
?   Enable Input        ?
?    ?
???????????????????????????????????????????????
```

**Альтернатива в одном узле:**

```
[On Dialogue Started] ?????? [Get Player Controller]
            ?    ?
[On Dialogue Ended] ?????         ?
     [Set Input Mode (Toggle)]
      ?
      ???? Input Enabled = (Event == "Ended")
```

### Пример 2: Показать UI диалога

```
?? On Dialogue Started ?????????????????
?          ?
?  Create Widget (WBP_DialogueUI)      ?
?         ?         ?
?         ?  ?
?  Add to Viewport     ?
? ?    ?
??  ?
?  Set Variable: DialogueWidgetRef      ?
??
?????????????????????????????????????????

?? On Dialogue Ended ???????????????????
?        ?
?  Get Variable: DialogueWidgetRef   ?
?         ?  ?
?  ?      ?
?  Is Valid?    ?
?         ?  ?
?       ?? True ??? Remove from Parent?
?     ?           ?
?         ?? False ??? (do nothing)     ?
?           ?
?????????????????????????????????????????
```

### Пример 3: Воспроизвести озвучку для каждой реплики

```
?? On Dialogue Node Changed (New Node, Previous Node) ??
?    ?
?  Is Valid? (New Node)     ?
?      ?              ?
?      ?? False ??? RETURN        ?
?      ?           ?
?      ?? True     ?
?    ?     ?
?   ?           ?
?      [Get Voice Clip from New Node]     ?
?     ?        ?
?        ?         ?
?      Is Valid? (Voice Clip)            ?
?       ?           ?
?     ?? False ??? RETURN    ?
?   ? ?
?        ?? True          ?
?  ?      ?
?                ?       ?
?      [Play Sound 2D]        ?
?          ?    ?
?        ???? Audio Component = Voice Clip    ?
?            ?
??????????????????????????????????????????????????????????
```

### Пример 4: Логирование для отладки

```
?? On Dialogue Started (Runner) ?????????????????
?           ?
?  Print String    ?
?    ?? Text: "Dialogue Started!"               ?
?  ?? Color: Green           ?
?    ?? Duration: 2.0           ?
?         ?
??????????????????????????????????????????????????

?? On Dialogue Ended ?????????????????????????????
?         ?
?  Print String   ?
?    ?? Text: "Dialogue Ended!"       ?
?    ?? Color: Red           ?
?    ?? Duration: 2.0              ?
?        ?
??????????????????????????????????????????????????

?? On Dialogue Node Changed (New, Previous) ?????
?        ?
?  Get Dialogue Text (New Node)       ?
?         ?           ?
?   ?    ?
?  To String      ?
?    ?                ?
?         ?      ?
?  Append ("New Line: " + Text)    ?
?     ?        ?
?  ?        ?
?  Print String           ?
?    ?? Text: Result   ?
?    ?? Color: Yellow   ?
?    ?? Duration: 3.0     ?
? ?
??????????????????????????????????????????????????
```

### Пример 5: Анимация NPC при разговоре

```
?? On Dialogue Node Changed (New Node, Previous) ????
?                ?
?  Branch (Is Valid? New Node)        ?
?     ?   ?
?     ?? True            ?
?      ?    ?
?         ?                ?
?    [Get Emotion Tag from New Node]              ?
?    ?            ?
?  ?           ?
?    Switch on Name (Emotion Tag) ?
?         ??
?      ?? "Happy" ??? Play Animation (Smile)   ?
?         ?? "Sad" ????? Play Animation (Frown)      ?
?         ?? "Angry" ??? Play Animation (Scowl)      ?
?         ?? Default ??? Play Animation (Neutral)    ?
?       ?
???????????????????????????????????????????????????????
```

### Пример 6: Подсчёт завершённых диалогов (достижения)

```
[Variables]
  - DialoguesCompleted (Integer) = 0

?? On Dialogue Ended ?????????????????????????????????
?         ?
?  Increment Int (DialoguesCompleted)       ?
?         ?           ?
??       ?
?  Branch (DialoguesCompleted >= 10)       ?
?     ?          ?
?     ?? True ??? Unlock Achievement "Chatty"        ?
?  ?   ?
?     ?? False     ?
?         ?      ?
?         ?          ?
?    Branch (DialoguesCompleted >= 50)?
?         ?    ?
?       ?? True ??? Unlock Achievement "Talker"    ?
?         ?   ?
?         ?? False ??? (continue tracking)           ?
?      ?
???????????????????????????????????????????????????????
```

---

## ?? Советы

### ? DO (Делайте так)

- ? Всегда проверяйте `Is Valid?` перед использованием узлов
- ? Используйте `Print String` для отладки
- ? Храните ссылки на UI виджеты в переменных
- ? Отписывайтесь от событий при Destroy
- ? Используйте цвета в `Print String` для разных типов событий

### ? DON'T (Не делайте так)

- ? Не храните ссылки на `Runner` долго - он удаляется после диалога
- ? Не вызывайте `StartDialogue` внутри `OnDialogueStarted` (бесконечный цикл!)
- ? Не забывайте проверять `Is Valid?` для `Previous Node` (может быть null)
- ? Не выполняйте тяжёлые операции синхронно в обработчиках

---

## ?? Отладка

### Событие не срабатывает?

1. ? Проверьте что `Dialogue Component` добавлен к актору
2. ? Убедитесь что событие подписано в `BeginPlay` или конструкторе
3. ? Проверьте логи (`Print String` в начале обработчика)
4. ? Убедитесь что диалог действительно запускается

### `Previous Node` всегда null?

- Это нормально для **первой реплики** диалога
- Используйте `Branch (Is Valid?)` для проверки

### UI не появляется?

1. ? Проверьте что виджет создан (`Is Valid?` после `Create Widget`)
2. ? Убедитесь что `Add to Viewport` вызван
3. ? Проверьте Z-Order виджета
4. ? Проверьте видимость (`Set Visibility`)

---

## ?? Полезные узлы Blueprint

### Работа с Dialogue Component

- `Get Active Runner` - получить текущий раннер
- `Is In Dialogue` - проверка, идёт ли диалог
- `Get Current Node` (через Runner) - текущая реплика
- `Get Dialogue Text` (через Node) - текст реплики
- `Get Speaker Name` (через Node) - имя говорящего

### Для UI

- `Create Widget`
- `Add to Viewport`
- `Remove from Parent`
- `Set Visibility`
- `Get Owning Player`

### Для аудио

- `Play Sound 2D`
- `Play Sound at Location`
- `Stop` (Audio Component)
- `Fade In` / `Fade Out`

### Для анимации

- `Play Animation` (UMG)
- `Play Montage` (Character)
- `Set Bool` (Animation Blueprint)

---

## ?? Следующие шаги

После освоения событий вы можете:

1. Создать систему субтитров
2. Добавить камеры для диалогов
3. Реализовать эмоциональные анимации
4. Создать систему репутации
5. Добавить влияние выборов на геймплей

**См. также:**
- [Полное руководство по событиям](06_DialogueEvents_Guide.md)
- [Примеры использования](05_Complete_Examples.md)
- [API Reference](../Source/DialogueSystemRuntime/Public/Components/DialogueComponent.h)

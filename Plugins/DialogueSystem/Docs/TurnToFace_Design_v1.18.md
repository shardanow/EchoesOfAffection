# Turn-To-Face System Design - v1.18

## ?? Goal

Add automatic turn-to-face functionality so NPCs and Player look at each other during dialogue **WITHOUT using sequences**.

## ?? Architecture Overview

### Three-Layer Approach:

```
???????????????????????????????????????????????????????????????
?  Layer 1: DialogueNode.ListenerId (Declarative)      ?
?  ???????????????????????????????????????????????????????   ?
?  ? Node: "Hello Alice!"    ?   ?
?  ? SpeakerId: Lianne?   ?
?  ? ListenerId: Alice  ? NEW! Designer specifies target?   ?
?  ???????????????????????????????????????????????????????   ?
?     ? Automatically processed     ?
???????????????????????????????????????????????????????????????
  ?
???????????????????????????????????????????????????????????????
?  Layer 2: DialogueRunner Auto-Detection    ?
?  ???????????????????????????????????????????????????????   ?
?  ? if (!Node->ListenerId.IsNone())          ?   ?
?  ? {          ?   ?
?  ?     EmitTurnToFaceEvent(SpeakerId, ListenerId);    ?   ?
?  ? }            ?   ?
?  ???????????????????????????????????????????????????????   ?
?    ? Emits GameEventBus event  ?
???????????????????????????????????????????????????????????????
       ?
???????????????????????????????????????????????????????????????
?  Layer 3: GameEventBus Event         ?
?  ???????????????????????????????????????????????????????   ?
?  ? Event: "GameEvent.Dialogue.TurnToFace"          ? ?
?  ? InstigatorActor: Lianne (who turns)    ?   ?
?  ? TargetActor: Alice (turn target)   ?   ?
?  ? StringParam: "Smooth" (rotation mode)      ?   ?
?  ? FloatParam: 0.5 (rotation duration)         ?   ?
?  ???????????????????????????????????????????????????????   ?
?    ? Subscribers handle rotation        ?
???????????????????????????????????????????????????????????????
           ?
???????????????????????????????????????????????????????????????
?  Subscribers (Blueprint/C++)    ?
?  ???????????????????????????????????????????????????????   ?
?  ?  BP_NPCActor: RotateToTarget(TargetActor, Speed)   ?   ?
?  ?  OR               ?   ?
?  ?  TurnToFaceComponent: HandleTurnToFaceEvent()       ?   ?
?  ???????????????????????????????????????????????????????   ?
???????????????????????????????????????????????????????????????
```

### Alternative: DialogueEffect_TurnToFace (Optional Override)

```
DLS Syntax: TurnToFace(Alice, Smooth=0.5)

???????????????????????????????????????????????????????????????
?  DialogueEffect_TurnToFace (Manual Override)      ?
?  ???????????????????????????????????????????????????????   ?
?  ?  // Can override ListenerId for specific nodes      ?   ?
?  ?TurnToFace(Player, Instant)       ?   ?
?  ?TurnToFace(Alice, Smooth=1.5)     ?   ?
?  ?TurnToFace(Forward) // Reset to forward        ?   ?
?  ???????????????????????????????????????????????????????   ?
?          ? Same GameEventBus event     ?
???????????????????????????????????????????????????????????????
```

---

## ?? Component Design

### 1. DialogueNode Extension

```cpp
USTRUCT(BlueprintType)
struct DIALOGUESYSTEMCORE_API FDialogueNodeData
{
  GENERATED_BODY()

    // ...existing fields...
    
    UPROPERTY(EditAnywhere, BlueprintReadWrite, Category = "Core")
    FName SpeakerId;  // Who speaks (existing)
    
    /** 
     * NEW v1.18: Who is being addressed
     * - Leave empty = no turn-to-face
     * - "Player" = turn to player
     * - NPC PersonaId = turn to that NPC
     */
    UPROPERTY(EditAnywhere, BlueprintReadWrite, Category = "Core")
    FName ListenerId;  // NEW!
    
    // ...existing fields...
};
```

**Default values:**
- NPC ? Player dialogue: `ListenerId = "Player"` (auto-set by editor)
- Player choice ? NPC: `ListenerId = <current NPC>` (auto-detect)
- NPC ? NPC: `ListenerId = <other NPC>` (manual)

---

### 2. DialogueEffect_TurnToFace

```cpp
/**
 * Turn-To-Face Effect - v1.18
 * 
 * Rotates participant to face target participant.
 * 
 * Features:
 * - Multiple rotation modes (Smooth, Instant, LookAt)
 * - Configurable rotation speed
 * - Optional head-only rotation
 * - GameEventBus integration (soft coupling)
 * 
 * Syntax:
 *   TurnToFace(Alice)  // Smooth rotation to Alice
 *   TurnToFace(Player, Instant)        // Instant snap to Player
 *   TurnToFace(Lianne, Smooth=1.5)     // 1.5 second rotation
 *   TurnToFace(Forward)              // Reset to forward direction
 */
UCLASS(BlueprintType, meta = (DisplayName = "Turn To Face"))
class DIALOGUESYSTEMCORE_API UDialogueEffect_TurnToFace : public UDialogueEffect
{
    GENERATED_BODY()

public:
    /** Who should turn (PersonaId or "Speaker" for current speaker) */
    UPROPERTY(EditAnywhere, BlueprintReadWrite, Category = "Effect")
    FName RotatingParticipantId;
    
    /** Who to turn towards (PersonaId, "Player", or "Forward" for reset) */
    UPROPERTY(EditAnywhere, BlueprintReadWrite, Category = "Effect")
    FName TargetParticipantId;
    
    /** Rotation mode */
    UPROPERTY(EditAnywhere, BlueprintReadWrite, Category = "Effect")
    ETurnToFaceMode RotationMode = ETurnToFaceMode::Smooth;
    
    /** Rotation duration (seconds) - ignored for Instant mode */
    UPROPERTY(EditAnywhere, BlueprintReadWrite, Category = "Effect", meta = (ClampMin = "0.1", ClampMax = "5.0"))
    float RotationDuration = 0.5f;
    
    /** Only rotate head/upper body (if supported by character rig) */
    UPROPERTY(EditAnywhere, BlueprintReadWrite, Category = "Effect")
    bool bHeadOnly = false;
    
    /** Wait for rotation to complete before continuing dialogue */
    UPROPERTY(EditAnywhere, BlueprintReadWrite, Category = "Effect")
    bool bWaitForCompletion = false;
    
protected:
  virtual void Execute_Implementation(UDialogueSessionContext* Context) override;
};
```

---

### 3. Rotation Modes

```cpp
/**
 * Turn-To-Face Rotation Mode
 * 
 * v1.18: Different rotation behaviors
 */
UENUM(BlueprintType)
enum class ETurnToFaceMode : uint8
{
    /** Smooth interpolated rotation over RotationDuration */
    Smooth UMETA(DisplayName = "Smooth"),
    
    /** Instant snap to target rotation */
  Instant UMETA(DisplayName = "Instant"),
    
    /** Look at target continuously (head/eyes tracking) */
    LookAt UMETA(DisplayName = "Look At"),
    
    /** Reset to forward direction (0, 0, 0) */
    Forward UMETA(DisplayName = "Forward")
};
```

---

### 4. GameEventBus Event

```cpp
/**
 * Event: GameEvent.Dialogue.TurnToFace
 * 
 * Emitted when participant should turn to face another participant.
 * 
 * Payload:
 *   EventTag: "GameEvent.Dialogue.TurnToFace"
 *   InstigatorActor: Actor that should turn (AActor*)
 *   TargetActor: Target to face (AActor* or nullptr for Forward mode)
 *   StringParam: RotationMode ("Smooth", "Instant", "LookAt", "Forward")
 *   FloatParam: RotationDuration (seconds, 0.0 for Instant)
 *   IntParam: bHeadOnly (0 = full body, 1 = head only)
 */
FGameEventPayload TurnToFacePayload;
TurnToFacePayload.EventTag = FGameplayTag::RequestGameplayTag("GameEvent.Dialogue.TurnToFace");
TurnToFacePayload.InstigatorActor = RotatingActor;
TurnToFacePayload.TargetActor = TargetActor;
TurnToFacePayload.StringParam = FName(*UEnum::GetValueAsString(RotationMode));
TurnToFacePayload.FloatParam = RotationDuration;
TurnToFacePayload.IntParam = bHeadOnly ? 1 : 0;
```

---

## ?? Usage Examples

### Example 1: Simple NPC ? Player dialogue

**DLS:**
```
NPC Lianne:
  "Hello, friend!"  # ListenerId automatically set to "Player"
```

**Result:** Lianne smoothly turns to face Player before speaking.

---

### Example 2: NPC ? NPC dialogue

**DLS:**
```
NPC Lianne:
  ListenerId: Alice
  "Alice, did you see that?"
  
NPC Alice:
  ListenerId: Lianne
  "Yes, it was amazing!"
```

**Result:** 
- Lianne turns to Alice
- Alice turns to Lianne
- Natural conversation flow

---

### Example 3: Manual override with effect

**DLS:**
```
NPC Lianne:
  "Watch out!"
  TurnToFace(Alice, Instant)  # Override: snap to Alice immediately
```

**Result:** Lianne instantly snaps to face Alice (urgent situation).

---

### Example 4: Dramatic turn during speech

**DLS:**
```
NPC Lianne:
  "I never thought..."
  TurnToFace(Forward)  # Turn away
  "...that it would end like this."
  TurnToFace(Player, Smooth=2.0)  # Slowly turn back to Player
```

**Result:** Dramatic cinematic rotation during dialogue.

---

### Example 5: Group conversation

**DLS:**
```
NPC Lianne:
  ListenerId: Player
  "You both need to hear this."
  TurnToFace(Alice)  # Turn to Alice mid-sentence
  "Alice, you're right."
  TurnToFace(Player)  # Turn back to Player
  "But we need to be careful."
```

**Result:** Lianne naturally addresses both Player and Alice during single dialogue line.

---

## ?? Integration Points

### For NPC Blueprints:

```cpp
// Blueprint: BP_NPCActor

Event OnGameEventReceived(FGameEventPayload Payload)
{
    if (Payload.EventTag == "GameEvent.Dialogue.TurnToFace")
    {
        if (Payload.InstigatorActor == this)  // I should turn
      {
          AActor* Target = Payload.TargetActor;
            FString Mode = Payload.StringParam.ToString();
            float Duration = Payload.FloatParam;
            
  if (Mode == "Smooth")
         {
      RotateToTarget(Target, Duration);
    }
            else if (Mode == "Instant")
      {
    SetActorRotation(LookAtRotation(Target));
   }
     // etc...
        }
    }
}
```

---

### Optional: TurnToFaceComponent (Helper Component)

```cpp
/**
 * Turn-To-Face Component - v1.18
 * 
 * Helper component that automatically subscribes to TurnToFace events
 * and handles rotation logic.
 * 
 * Add to NPC blueprints for automatic turn-to-face behavior.
 */
UCLASS(BlueprintType, meta = (BlueprintSpawnableComponent))
class DIALOGUESYSTEMRUNTIME_API UTurnToFaceComponent : public UActorComponent
{
GENERATED_BODY()

public:
    /** Enable/disable turn-to-face for this actor */
    UPROPERTY(EditAnywhere, BlueprintReadWrite, Category = "Turn To Face")
    bool bEnableTurnToFace = true;
    
    /** Default rotation speed (can be overridden by event) */
 UPROPERTY(EditAnywhere, BlueprintReadWrite, Category = "Turn To Face")
    float DefaultRotationSpeed = 2.0f;  // degrees per second
    
protected:
    virtual void BeginPlay() override;
    virtual void EndPlay(const EEndPlayReason::Type EndPlayReason) override;
    virtual void TickComponent(float DeltaTime, ELevelTick TickType, FActorComponentTickFunction* ThisTickFunction) override;
    
private:
    void SubscribeToEvents();
  void UnsubscribeFromEvents();
    void OnTurnToFaceEvent(const FGameEventPayload& Payload);
    
    void StartRotation(AActor* Target, ETurnToFaceMode Mode, float Duration);
    void UpdateRotation(float DeltaTime);
    
    // Rotation state
    bool bIsRotating = false;
    FRotator StartRotation;
    FRotator TargetRotation;
    float RotationProgress = 0.0f;
    float RotationDuration = 0.5f;
    ETurnToFaceMode CurrentMode;
};
```

---

## ?? Technical Details

### Rotation Calculation:

```cpp
// Calculate target rotation
FVector DirectionToTarget = (TargetLocation - ActorLocation).GetSafeNormal2D();
FRotator TargetRotation = DirectionToTarget.Rotation();

// Smooth interpolation
float Alpha = FMath::Clamp(ElapsedTime / Duration, 0.0f, 1.0f);
FRotator CurrentRotation = FMath::RInterpTo(StartRotation, TargetRotation, DeltaTime, InterpSpeed);
```

### Collision Handling:

- Turn-to-face **ONLY affects rotation**, not position
- No collision/sweep needed (unlike positioning system)
- Safe to use during dialogue without movement conflicts

### Performance:

- Event-driven (no constant polling)
- Rotation done on Tick only while active
- Automatically stops when target reached
- Minimal CPU overhead

---

## ?? Migration Path

### Phase 1: Core System (v1.18.0)
- ? Add `ListenerId` to DialogueNode
- ? Implement `DialogueEffect_TurnToFace`
- ? Add parser support
- ? Emit GameEventBus events
- ? Documentation

### Phase 2: Helper Component (v1.18.1)
- Create `UTurnToFaceComponent`
- Blueprint library functions
- Example implementations

### Phase 3: Editor Improvements (v1.18.2)
- Auto-populate `ListenerId` in dialogue editor
- Visual indicators for turn-to-face
- Debugging tools

---

## ?? Success Criteria

- ? NPCs automatically face Player during dialogue (if ListenerId set)
- ? NPCs can face other NPCs in multi-participant dialogues
- ? Effect can override automatic behavior
- ? Smooth and instant rotation modes work
- ? No hard dependencies (GameEventBus only)
- ? Works with existing positioning system
- ? Documented with examples

---

**Version:** 1.18 Design  
**Date:** 2025-11-28  
**Status:** ?? Design Complete - Ready for Implementation

# Как отслеживать события диалога из Actor игрока (Blueprint Guide)

## ?? Обзор

Есть **два способа** отслеживать события диалогов из Blueprint игрока:

1. **Через DialogueSubsystem** (Глобально) — отлавливает ВСЕ диалоги в игре
2. **Через конкретный DialogueComponent** (Локально) — отлавливает только диалоги с конкретным NPC

---

## ?? Способ 1: Глобальные события через DialogueSubsystem (РЕКОМЕНДУЕТСЯ)

Это самый правильный и удобный способ для игрока - все события приходят автоматически!

### Blueprint Setup (Player Character):

```
Event BeginPlay (Player)
    ?
    ?
[Get Game Instance]
    ?
    ?
[Get Subsystem] (DialogueSubsystem)
    ?
    ?
[Bind Event to On Any Dialogue Started] ??? Custom Event: OnDialogueStartedGlobal
[Bind Event to On Any Dialogue Ended] ??? Custom Event: OnDialogueEndedGlobal
[Bind Event to On Any Dialogue Node Changed] ??? Custom Event: OnNodeChangedGlobal
```

### Шаг за шагом:

#### 1. Получить DialogueSubsystem в BeginPlay

```
Event BeginPlay
    ?
    ?
Get Game Instance
    ?
    ?
Get Subsystem (DialogueSubsystem) ??? [Store as Variable: CachedDialogueSubsystem]
```

#### 2. Подписаться на события

```
[CachedDialogueSubsystem]
    ?
    ??? Bind Event to On Any Dialogue Started ??? OnDialogueStartedGlobal
  ??? Bind Event to On Any Dialogue Ended ??? OnDialogueEndedGlobal
    ??? Bind Event to On Any Dialogue Node Changed ??? OnNodeChangedGlobal
```

#### 3. Создать обработчики событий

##### On Dialogue Started Global (Runner, Player, NPC)
```
Custom Event: OnDialogueStartedGlobal (Runner, Player, NPC)
    ?
    ?
[Branch: Is Player == Self?]
    ?
    ??? True (это диалог с ЭТИМ игроком)
    ?   ?
    ?   ?
    ?   [Disable Player Movement]
 ?   [Set Input Mode UI Only]
    ?   [Show Dialogue UI Widget]
    ?   [Store Runner Reference]
    ?
 ??? False (другой игрок в мультиплеере - игнорируем)
```

##### On Dialogue Ended Global (Player, NPC)
```
Custom Event: OnDialogueEndedGlobal (Player, NPC)
    ?
    ?
[Branch: Is Player == Self?]
?
    ??? True
    ?   ?
    ?   ?
    ?   [Enable Player Movement]
    ?   [Set Input Mode Game Only]
    ?   [Hide Dialogue UI Widget]
    ?   [Clear Runner Reference]
    ?
    ??? False (ignore)
```

##### On Node Changed Global (NewNode, PreviousNode, Runner)
```
Custom Event: OnNodeChangedGlobal (NewNode, PreviousNode, Runner)
  ?
    ?
[Is Valid? NewNode]
    ?
    ??? True
    ? ?
    ?   ?
    ?   [Get Dialogue Text from NewNode]
    ?   ?
    ?   ?
    ?   [Update Subtitle UI]
    ?   ?
    ?   ?
    ?   [Branch: VoiceClip Is Valid?]
    ??
    ?   ??? True ??? Play Sound 2D (VoiceClip)
    ?   ??? False ??? (skip)
?
    ??? False (first node or error)
```

---

### Полный пример Blueprint (Player Character):

```
???????????????????????????????????????????????????????????????
   Event BeginPlay
???????????????????????????????????????????????????????????????
  ?
           ?
      [Get Game Instance]
         ?
   ?
      [Get Subsystem: DialogueSubsystem]
          ?
   ?
    [Set Variable: CachedDialogueSubsystem]
    ?
    ?
  [Bind: On Any Dialogue Started]
    ??? OnPlayerDialogueStarted
 ?
    [Bind: On Any Dialogue Ended]
          ??? OnPlayerDialogueEnded
          ?
    [Bind: On Any Dialogue Node Changed]
          ??? OnPlayerNodeChanged
???????????????????????????????????????????????????????????????

???????????????????????????????????????????????????????????????
       Custom Event: OnPlayerDialogueStarted
         (Runner, Player, NPC)
???????????????????????????????????????????????????????????????
    ?
            ?
              [Equal: Player == Self?]
        ?
        ?????????????
           ?           ?
             TRUE        FALSE
          ? ?
 ?           ??? [RETURN]
       [Get Player Controller]
          ?
         ?
          [Disable Input]
       ?
            ?
     [Create Widget: WBP_DialogueUI]
     ?
   ?
        [Add to Viewport]
   ?
        ?
    [Store: CurrentDialogueWidget]
      ?
?
        [Store: CurrentRunner]
        ?
     ?
    [Print: "Dialogue Started!"]
???????????????????????????????????????????????????????????????

???????????????????????????????????????????????????????????????
       Custom Event: OnPlayerDialogueEnded
       (Player, NPC)
???????????????????????????????????????????????????????????????
                ?
    ?
        [Equal: Player == Self?]
   ?
         ?????????????
        ?           ?
  TRUE          FALSE
    ?       ?
  ?           ??? [RETURN]
       [Get Player Controller]
         ?
          ?
          [Enable Input]
        ?
     ?
    [Get: CurrentDialogueWidget]
   ?
           ?
          [Is Valid?]
  ?
 ??? True ??? [Remove from Parent]
           ??? False
           ?
                  ?
 [Clear: CurrentRunner]
   ?
                ?
      [Clear: CurrentDialogueWidget]
     ?
             ?
      [Print: "Dialogue Ended!"]
???????????????????????????????????????????????????????????????

???????????????????????????????????????????????????????????????
       Custom Event: OnPlayerNodeChanged
         (NewNode, PreviousNode, Runner)
???????????????????????????????????????????????????????????????
          ?
      ?
     [Is Valid? NewNode]
            ?
            ?????????????
      ?           ?
             TRUE       FALSE
             ?       ?
       ?           ??? [RETURN]
      [Get Dialogue Text: NewNode]
        ?
            ?
    [Get: CurrentDialogueWidget]
   ?
          ?
   [Call: UpdateText]
                  ?
   ?
         [Get: NewNode.VoiceClip]
    ?
 ?
            [Is Valid?]
   ?
            ??? True ??? [Play Sound 2D]
    ??? False
      ?
       ?
       [Get: NewNode.EmotionTag]
          ?
       ?
   [Switch on Name]
   ?
           ??? "Happy" ??? [Play Camera Shake: Happy]
     ??? "Sad" ????? [Play Camera Shake: Sad]
     ??? "Angry" ??? [Play Camera Shake: Angry]
     ??? Default ??? (no effect)
???????????????????????????????????????????????????????????????
```

---

## ?? Способ 2: Локальные события через DialogueComponent (альтернатива)

Если хотите отслеживать только конкретного NPC, можно подписаться напрямую на его DialogueComponent.

### Blueprint Setup:

```
Event Begin Overlap (Interaction Trigger)
    ?
    ?
[Cast to NPC_Character] (Other Actor)
 ?
    ?
[Get Component by Class: DialogueComponent]
    ?
    ?
[Set Variable: CurrentNPCDialogueComponent]
    ?
    ?
[Bind Event to On Dialogue Started] ??? OnNPCDialogueStarted
[Bind Event to On Dialogue Ended] ??? OnNPCDialogueEnded
[Bind Event to On Dialogue Node Changed] ??? OnNPCNodeChanged

??????????????????????????????????????????????????????????

Event End Overlap
    ?
    ?
[Get: CurrentNPCDialogueComponent]
    ?
    ?
[Is Valid?]
    ?
??? True
    ?   ?
    ?   ?
    ?   [Unbind Event: On Dialogue Started]
    ?   [Unbind Event: On Dialogue Ended]
    ?   [Unbind Event: On Dialogue Node Changed]
    ?   ?
 ?   ?
    ?   [Clear Variable: CurrentNPCDialogueComponent]
    ?
    ??? False (nothing to unbind)
```

### Обработчики:

```
Custom Event: OnNPCDialogueStarted (Runner)
    ?
    ?
[Disable Input]
[Show Dialogue UI]

Custom Event: OnNPCDialogueEnded
    ?
    ?
[Enable Input]
[Hide Dialogue UI]

Custom Event: OnNPCNodeChanged (NewNode, PreviousNode)
    ?
    ?
[Update UI with new text]
[Play voice line]
```

---

## ?? Сравнение подходов

| Критерий | Глобальный (Subsystem) | Локальный (Component) |
|----------|------------------------|----------------------|
| **Простота** | ????? Очень просто | ??? Средне |
| **Универсальность** | Ловит ВСЕ диалоги | Только конкретный NPC |
| **Подписка** | Один раз в BeginPlay | При каждом Overlap |
| **Отписка** | Не нужна (Subsystem живёт всю игру) | Обязательно при EndOverlap |
| **Мультиплеер** | Нужна проверка Player == Self | Работает из коробки |
| **Рекомендуется для** | **Игрока, UI Manager** | AI, спец. логика |

---

## ?? Checklist для Player Blueprint

### Глобальный подход (рекомендуется):

- [ ] Получить DialogueSubsystem в BeginPlay
- [ ] Подписаться на OnAnyDialogueStarted
- [ ] Подписаться на OnAnyDialogueEnded
- [ ] Подписаться на OnAnyDialogueNodeChanged
- [ ] Проверять `Player == Self` в обработчиках (для мультиплеера)
- [ ] Управлять Input Mode (Disable/Enable)
- [ ] Управлять UI (Show/Hide)
- [ ] Воспроизводить озвучку при смене нод

### Локальный подход (альтернатива):

- [ ] Найти DialogueComponent при Overlap
- [ ] Подписаться на события компонента
- [ ] **Обязательно отписаться при EndOverlap**
- [ ] Управлять Input Mode
- [ ] Управлять UI

---

## ?? Типичные ошибки

### ? Ошибка 1: Забыли проверить Player == Self (мультиплеер)

**Проблема:** События срабатывают для всех игроков
**Решение:**
```
[Branch: Player == Self]
    ??? True ??? Handle event
    ??? False ??? RETURN (ignore)
```

### ? Ошибка 2: Не сохранили ссылку на Widget

**Проблема:** Не можем скрыть UI при завершении диалога
**Решение:** Храните ссылку в переменной:
```
On Dialogue Started:
    Create Widget ??? Store in: CurrentDialogueWidget

On Dialogue Ended:
    Get: CurrentDialogueWidget ??? Remove from Parent
```

### ? Ошибка 3: Забыли отписаться (локальный подход)

**Проблема:** Memory leak, события срабатывают несколько раз
**Решение:** Всегда отписывайтесь:
```
Event End Overlap:
    Unbind Event: On Dialogue Started
    Unbind Event: On Dialogue Ended
    Unbind Event: On Dialogue Node Changed
```

### ? Ошибка 4: Не проверили Is Valid для NewNode

**Проблема:** Crash на первой ноде
**Решение:**
```
[Is Valid? NewNode]
    ??? True ??? Process node
    ??? False ??? RETURN
```

---

## ?? Продвинутые примеры

### Пример 1: Achievements System

```
Custom Event: OnPlayerDialogueEnded (Player, NPC)
    ?
  ?
[Branch: Player == Self]
    ?
    ??? True
    ?   ?
    ?   ?
    ?   [Increment: TotalDialoguesCompleted]
    ?   ?
    ?   ?
    ?   [Branch: TotalDialoguesCompleted >= 10]
  ?   ?
    ?   ??? True ??? [Unlock Achievement: "Chatty"]
  ?   ??? False
    ?
  ??? False
```

### Пример 2: Dynamic Camera System

```
Custom Event: OnPlayerDialogueStarted (Runner, Player, NPC)
    ?
    ?
[Branch: Player == Self]
    ?
    ??? True
    ?   ?
    ?   ?
    ?   [Get NPC Camera Component]
    ?   ?
    ?   ?
    ?   [Is Valid?]
    ?   ?
    ?   ??? True
    ?   ?   ?
    ?   ?   ?
    ?   ?   [Set View Target with Blend]
    ?   ?   ?  ?? Target: NPC Camera
    ?   ?   ?  ?? Blend Time: 0.5s
    ?   ?
    ?   ??? False ??? [Use Default Camera]
    ?
    ??? False
```

### Пример 3: Subtitle System

```
Custom Event: OnPlayerNodeChanged (NewNode, PreviousNode, Runner)
    ?
    ?
[Is Valid? NewNode]
    ?
    ??? True
    ?   ?
    ?   ?
    ?   [Get Dialogue Text]
    ?   ?
    ?   ?
    ?   [Get Speaker Name]
    ?   ?
    ?   ?
    ?   [Get VoiceClip Duration]
    ?   ?
    ?   ?
    ?   [Show Subtitle]
    ?   ?  ?? Text: Dialogue Text
    ?   ?  ?? Speaker: Speaker Name
    ?   ?  ?? Duration: VoiceClip Duration (or 3s default)
    ?
    ??? False
```

---

## ?? Связанные материалы

- [DialogueEvents Guide](06_DialogueEvents_Guide.md) - Полная документация по событиям
- [DialogueEvents Quick Start](06_DialogueEvents_QuickStart.md) - Быстрый старт
- [DialogueEvents CheatSheet](DialogueEvents_CheatSheet.md) - Шпаргалка

---

## ?? FAQ

**Q: Нужно ли мне использовать оба подхода одновременно?**  
A: Нет! Выберите один:
- **Глобальный** (через Subsystem) - для игрока, UI менеджера
- **Локальный** (через Component) - для специфичной логики NPC

**Q: Как работает это в мультиплеере?**  
A: Глобальные события приходят всем клиентам, поэтому проверяйте `Player == Self`

**Q: Что если забыл отписаться от локальных событий?**  
A: Memory leak и дублирование обработки событий. Всегда отписывайтесь!

**Q: Можно ли слушать события из Widget Blueprint?**  
A: Да! Передайте ссылку на Subsystem в Widget и подпишитесь там же.

**Q: OnAnyDialogueStarted не срабатывает!**  
A: Проверьте:
1. Subsystem получен правильно
2. Событие подписано в BeginPlay
3. Диалог действительно запускается
4. Добавьте `Print String` для отладки

---

**Версия:** 1.1.0  
**Дата:** 22.01.2025  
**Автор:** DialogueSystem Team

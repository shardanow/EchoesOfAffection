# ?? v1.3.1 Parser Separation - Manual Cleanup Required

> **Status:** ?? **COMPILATION ERROR**  
> **Issue:** Old parsing code still present in DialogueEffectExecutor.cpp  
> **Action Required:** Manual cleanup

---

## ? What's Complete (80%):

### 1. NEW: UDialogueEffectParser ?
- ? Created `DialogueEffectParser.h` - Full API
- ? Created `DialogueEffectParser.cpp` - Full implementation
- ? All 10 effect types supported
- ? Parse single effect
- ? Parse effect list
- ? Caching system
- ? Blueprint library

### 2. DialogueEffectExecutor.h Updated ?
- ? Removed all parsing method declarations
- ? Kept only execution methods:
  - ExecuteEffect()
  - ExecuteEffects()
  - ReverseEffect()
  - ReverseEffects()
  - CanReverseEffect()

---

## ? What Needs Manual Fix:

### DialogueEffectExecutor.cpp - Remove Old Code

**Location:** `Plugins/DialogueSystem/Source/DialogueSystemCore/Private/Effects/DialogueEffectExecutor.cpp`

**Problem:** File contains OLD parsing methods that no longer exist in .h:
- `ParseEffect()`
- `ParseSingleEffect()`
- `ParseGoldEffect()`
- `ParseTrustEffect()`
- `ParseAffinityEffect()`
- ... и другие 10+ методов

**Solution:**

**DELETE these sections from DialogueEffectExecutor.cpp:**

1. ? `UDialogueEffect* UDialogueEffectExecutor::ParseEffect(...)`
2. ? `TArray<UDialogueEffect*> UDialogueEffectExecutor::ParseEffectList(...)`
3. ? `TArray<FString> UDialogueEffectExecutor::TokenizeExpression(...)`
4. ? `UDialogueEffect* UDialogueEffectExecutor::ParseSingleEffect(...)`
5. ? `void UDialogueEffectExecutor::ExecuteString(...)`
6. ? All `Parse*Effect()` methods (10+ methods)

**KEEP these sections:**

1. ? All effect Execute_Implementation() methods
2. ? All effect Reverse_Implementation() methods
3. ? All effect GetDisplayText_Implementation() methods
4. ? ExecuteEffect() - execution only
5. ? ExecuteEffects() - execution only
6. ? ReverseEffect() - reversal only
7. ? ReverseEffects() - reversal only
8. ? CanReverseEffect() - query only

---

## ?? What DialogueEffectExecutor.cpp Should Look Like:

```cpp
// Copyright Epic Games, Inc. All Rights Reserved.

#include "Effects/DialogueEffectExecutor.h"
#include "Core/DialogueContext.h"

// ==================================================================
// Effect Implementations (Execute, Reverse, GetDisplayText)
// ==================================================================

// UDialogueEffect_ModifyAffinity
void UDialogueEffect_ModifyAffinity::Execute_Implementation(UDialogueSessionContext* Context)
{
    // ... existing code ...
}

void UDialogueEffect_ModifyAffinity::Reverse_Implementation(UDialogueSessionContext* Context)
{
    // ... existing code ...
}

FText UDialogueEffect_ModifyAffinity::GetDisplayText_Implementation() const
{
    // ... existing code ...
}

// ... all other effects (ModifyTrust, ModifyInventory, etc.)

// ==================================================================
// Executor Methods (EXECUTION ONLY, NO PARSING)
// ==================================================================

void UDialogueEffectExecutor::ExecuteEffect(UDialogueEffect* Effect, UDialogueSessionContext* Context)
{
    if (Effect && Context)
    {
        Effect->Execute(Context);
    }
}

void UDialogueEffectExecutor::ExecuteEffects(const TArray<UDialogueEffect*>& Effects, UDialogueSessionContext* Context)
{
    for (UDialogueEffect* Effect : Effects)
    {
ExecuteEffect(Effect, Context);
    }
}

void UDialogueEffectExecutor::ReverseEffect(UDialogueEffect* Effect, UDialogueSessionContext* Context)
{
    if (Effect && Context && Effect->SupportsReverse())
    {
        Effect->Reverse(Context);
    }
}

void UDialogueEffectExecutor::ReverseEffects(const TArray<UDialogueEffect*>& Effects, UDialogueSessionContext* Context)
{
    for (int32 i = Effects.Num() - 1; i >= 0; --i)
    {
        ReverseEffect(Effects[i], Context);
    }
}

bool UDialogueEffectExecutor::CanReverseEffect(UDialogueEffect* Effect) const
{
    return Effect && Effect->SupportsReverse();
}
```

---

## ?? Manual Steps Required:

1. **Open:** `Plugins/DialogueSystem/Source/DialogueSystemCore/Private/Effects/DialogueEffectExecutor.cpp`

2. **Delete** all parsing methods (approximately lines 700-1000):
   - Ctrl+F: `ParseEffect`
   - Ctrl+F: `ParseSingleEffect`
   - Ctrl+F: `TokenizeExpression`
   - Ctrl+F: `ExecuteString`
   - Delete all these methods

3. **Keep** all effect implementations:
   - ModifyAffinity
   - ModifyTrust
   - ModifyInventory
   - ModifyGold
   - SetMemory
   - AddWorldStateTag
   - RemoveWorldStateTag
   - SetVariable
   - StartQuest
   - CompleteQuest
   - Composite

4. **Keep** executor methods:
   - ExecuteEffect()
   - ExecuteEffects()
 - ReverseEffect()
   - ReverseEffects()
   - CanReverseEffect()

5. **Remove** EffectCache field (no longer needed)

6. **Compile** and verify

---

## ?? Expected Result After Cleanup:

**File Structure:**
```
DialogueEffectExecutor.cpp
??? Effect Implementations (~600 lines)
?   ??? ModifyAffinity (Execute, Reverse, GetDisplayText)
?   ??? ModifyTrust (Execute, Reverse, GetDisplayText)
?   ??? ... (all 11 effects)
?   ??? Composite (Execute, Reverse, GetDisplayText, SupportsReverse)
??? Executor Methods (~30 lines)
    ??? ExecuteEffect()
    ??? ExecuteEffects()
    ??? ReverseEffect()
    ??? ReverseEffects()
    ??? CanReverseEffect()
```

**Total:** ~630 lines (down from ~1000+ lines)

---

## ?? Progress:

| Task | Status | Notes |
|------|--------|-------|
| DialogueVariant | ? Complete | v1.3.1 Part 1 |
| DialogueContext Type-Safe | ? Complete | v1.3.1 Part 1 |
| DialogueEffectParser | ? Complete | NEW class |
| DialogueEffectExecutor.h | ? Complete | Cleaned |
| DialogueEffectExecutor.cpp | ? **MANUAL** | **Needs cleanup** |
| Compilation | ? Failed | **Waiting for cleanup** |

---

## ?? After Manual Cleanup:

1. Compile project
2. Test Parser:
   ```cpp
   UDialogueEffectParser* Parser = NewObject<UDialogueEffectParser>();
   UDialogueEffect* Effect = Parser->ParseEffect("SetVariable(gold, 100)");
   ```

3. Test Executor:
   ```cpp
   UDialogueEffectExecutor* Executor = NewObject<UDialogueEffectExecutor>();
   Executor->ExecuteEffect(Effect, Context);
   ```

4. Create documentation
5. Update CHANGELOG

---

**Status:** Waiting for manual cleanup of DialogueEffectExecutor.cpp  
**ETA:** 10-15 minutes  
**Next:** Compilation + Testing

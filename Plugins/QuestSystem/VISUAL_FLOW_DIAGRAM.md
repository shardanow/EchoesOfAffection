# ?? Quest System - Визуальная схема

## ?? Полный поток: От взаимодействия до прогресса квеста

```
???????????????????????????????????????????????????????????????????????????
?           ИГРОК ПОДХОДИТ К NPC      ?
???????????????????????????????????????????????????????????????????????????
       ?
   ?????????????????????????????????
?   BP_Lianne (NPC Actor)    ?
                ?   ?? GameplayTags: NPC.Lianne ? ? ОСНОВНОЙ ИСТОЧНИК ID
 ?   ?? QuestGiverComponent      ?
?   ?????????????????????????????????
    ?      ?    ?
        ??????????????????????????
        ?   ИКОНКА НАД ГОЛОВОЙ          ?
        ? (Quest Giver)     ?
        ?          ?
        ?   ???????????????????????     ?
        ?   ?GetQuestIndicatorIcon?     ?
   ?   ?  (QuestGiver)       ? ?
   ?   ???????????????????????     ?
        ?      ?     ?    ?
        ?   Доступен? ?  Активен? ?  Завершён? ?
        ?      ?  ?     ??     ?          ?
        ?!  ?     ?   ? ?  ?
        ????????????????????????????????
   ?
        ?????????????????????????????????????????????
        ?     ИГРОК КЛИКАЕТ НА NPC       ?
      ?????????????????????????????????????????????
?
??????????????????????????????????
?   QuestGiverComponent          ?
?   ?? GetAvailableQuests() ?
?       ?? Фильтрация:           ?
?   ?? Dependencies?     ?
?           ?? Already Active?       ?
?  ?? Can Start?   ?
??????????????????????????????????
      ?
     ???????????????????????
        ?  ПОКАЗАТЬ UI КВЕСТОВ  ?
        ?  - Доступные квесты   ?
      ?  - Квесты для сдачи   ?
        ???????????????????????
         ?
      [ИГРОК ВЫБИРАЕТ "START QUEST"]
      ?
    ???????????????????????????
        ? QuestGiverComponent::   ?
        ? AcceptQuest() ?
        ???????????????????????????
        ?
        ???????????????????????????
        ? QuestSubsystem::      ?
        ?   StartQuestAsync()   ?
        ???????????????????????????
?
        ???????????????????????????
        ? QuestProgressManager::  ?
        ?   StartQuestInternal()  ?
        ? - Создать FQuestProgress?
     ?   - State: Active   ?
     ?   - Objectives: 0/1       ?
        ???????????????????????????
  ?
   ????????????????????????????????????
 ? OnQuestStarted.Broadcast()   ?
        ?  ?? Quest Tracker Widget ?
        ?     обновляется     ?
        ????????????????????????????????


???????????????????????????????????????????????????????????????????????????
?       ИГРОК НАЧИНАЕТ ДИАЛОГ        ?
???????????????????????????????????????????????????????????????????????????
  ?
        ????????????????????????????????????????????
        ? DialogueSubsystem::StartDialogue()       ?
        ?  (Player, BP_Lianne, DialogueAsset)      ?
   ????????????????????????????????????????????
        ?
        ????????????????????????????????????????????????????????????
        ? ИЗВЛЕЧЕНИЕ NPC ID             ?
        ?  1?? Приоритет: GameplayTags           ?
      ? ?? IGameplayTagAssetInterface       ?
        ?     ?? GetOwnedGameplayTags()   ?
  ?     ?? Ищем тег "NPC.*"   ?
  ?     ?? Извлекаем "Lianne" из "NPC.Lianne"  ?
  ?  2?? Fallback: Actor Name     ?
?     ?? GetName() ? "BP_Lianne_C_1"              ?
        ?     ?? RemoveFromStart("BP_") ? "Lianne_C_1"      ?
  ?     ?? Left(UnderscoreIndex) ? "Lianne"          ?
   ?         ?
        ?  Результат: NpcId = "Lianne" ?      ?
  ????????????????????????????????????????????????????????????
 ?
    ????????????????????????????????????????????
        ? UGameEventBusLibrary::EmitDialogueEvent()?
        ?  EventTag: GameEvent.Dialogue.Started    ?
  ?  StringParam: "Lianne" ? NPC ID!         ?
   ?  Instigator: Player             ?
        ?  Target: BP_Lianne                  ?
        ????????????????????????????????????????????
       ?
     ????????????????????????????????????????????
        ? GameEventBusSubsystem::EmitEvent()       ?
        ?  Payload:     ?
        ?   ?? EventTag: GameEvent.Dialogue.Started?
     ??? StringParam: "Lianne"          ?
        ?   ?? IntParam: 0       ?
        ?   ?? Instigator: Player?
        ?   ?? Target: BP_Lianne      ?
        ????????????????????????????????????????????
     ?
?????????????????????????????????????????????????????
 ? BroadcastEvent() - оповещает подписчиков         ?
?  Подписчики:   ?
        ?   ?? QuestEventBridge ?                  ?
   ?   ?? DialogueSystem    ?
    ?   ?? (другие системы)         ?
     ?????????????????????????????????????????????????????
?
        ?????????????????????????????????????????????????????
        ? QuestEventBridge::OnGameEvent(Payload)      ?
        ?  [LogQuestBridge] ?? Received game event: ?
        ?   'GameEvent.Dialogue.Started' |   ?
        ?   StringParam='Lianne'            ?
     ?????????????????????????????????????????????????????
        ?
      ?????????????????????????????????????????????????????
    ? QuestEventBridge::ForwardToQuestSystem()          ?
    ?  ?? Вызывает QuestEventBus   ?
        ?????????????????????????????????????????????????????
      ?
        ?????????????????????????????????????????????????????
        ? QuestEventBus::OnGameEvent(Payload)      ?
    ?  Для каждого АКТИВНОГО квеста:     ?
  ?   ?? GetAllActiveQuests()        ?
      ?   ?? Проверить каждую Objective     ?
        ?????????????????????????????????????????????????????
              ?
        ?????????????????????????????????????????????????????
        ? Проверка Objective: "Talk to Lianne" ?
        ?   Progress: 0 / 1        ?
        ?   Conditions: [1 condition]             ?
   ?    ?
        ?   Condition[0]:     ?
    ?     ?? EventTag: GameEvent.Dialogue.Started       ?
     ?     ?? NpcId: Lianne          ?
    ?     ?? RequiredCount: 1  ?
        ?????????????????????????????????????????????????????
                 ?
      ?????????????????????????????????????????????????????
     ? QuestEventBus::CheckCondition()            ?
        ?         ?
?  [1/4] EventTag Check:     ?
    ?   Payload.EventTag: GameEvent.Dialogue.Started    ?
        ?   Condition.EventTag: GameEvent.Dialogue.Started  ?
        ? Result: ? MATCH!  ?
        ?              ?
        ?  [2/4] NpcId Check:             ?
        ?   Payload.StringParam: "Lianne"    ?
        ?   Condition.NpcId: "Lianne"  ?
     ?   Result: ? MATCH!        ?
        ?     ?
        ?  [3/4] ItemId Check:      ?
  ?   Condition.ItemId: (None) ? ? SKIP    ?
        ?       ?
     ?  [4/4] QuestId Check:       ?
        ?   Condition.QuestId: (None) ? ? SKIP    ?
        ?  ?
      ?  FINAL RESULT: ? ALL CHECKS PASSED!              ?
 ?????????????????????????????????????????????????????
?
        ?????????????????????????????????????????????????????
  ? [LogQuestEventBus] ??? MATCH FOUND! Adding progress?
   ?   Objective: "Talk to Lianne"         ?
        ?   Current Progress: 0 ? 1 ?
        ?   Required Count: 1   ?
        ?????????????????????????????????????????????????????
    ?
        ?????????????????????????????????????????????????????
      ? QuestProgressManager::AddObjectiveProgress()      ?
        ?   ?? Progress.ObjectiveStates[0].CurrentProgress++?
     ?   ?? 0 ? 1       ?
        ?????????????????????????????????????????????????????
 ?
      ?????????????????????????????????????????????????????
        ? Проверка завершения Objective:         ?
 ?   CurrentProgress (1) >= RequiredCount (1)        ?
        ?   Result: ? OBJECTIVE COMPLETED!          ?
      ?????????????????????????????????????????????????????
?
        ?????????????????????????????????????????????????????
        ? OnObjectiveCompleted.Broadcast()     ?
        ?   ?? Quest Tracker Widget обновляется     ?
     ?       ? Talk to Lianne (1/1) DONE!      ?
        ?????????????????????????????????????????????????????
     ?
        ?????????????????????????????????????????????????????
        ? Проверка завершения квеста:           ?
        ?   Все Objectives завершены?               ?
  ?   Result: ? YES             ?
   ?????????????????????????????????????????????????????
    ?
        ?????????????????????????????????????????????????????
        ? QuestProgressManager::MarkQuestAsCompletable()    ?
 ?   ?? Progress.State = Completable       ?
   ?   ?? Player может сдать квест!   ?
 ?????????????????????????????????????????????????????
         ?
        ?????????????????????????????????????????????????????
        ? OnQuestCompletable.Broadcast()         ?
     ?   ?? UI обновляется:   ?
        ?    - Quest Tracker: ? Quest готов к сдаче     ?
        ?       - Иконка над Lianne: ? (золотая галочка)   ?
        ?????????????????????????????????????????????????????


???????????????????????????????????????????????????????????????????????????
?        ИГРОК СДАЁТ КВЕСТ У NPC     ?
???????????????????????????????????????????????????????????????????????????
         ?
        ????????????????????????????????????????????
     ? QuestGiverComponent::TurnInQuest()       ?
        ????????????????????????????????????????????
          ?
        ????????????????????????????????????????????
        ? QuestSubsystem::CompleteQuest()     ?
   ????????????????????????????????????????????
?
        ????????????????????????????????????????????
        ? QuestProgressManager::CompleteQuest()    ?
        ?   ?? State: Completable ? Completed      ?
        ?   ?? CompletionTime = Now     ?
        ?   ?? EmitEvent: GameEvent.Quest.Completed?
  ????????????????????????????????????????????
          ?
    ????????????????????????????????????????????
        ? QuestRewardSystem::GiveRewards()         ?
        ?   ?? XP: +100           ?
   ?   ?? Gold: +50       ?
  ?   ?? Items: [Potion x3]       ?
      ????????????????????????????????????????????
   ?
        ????????????????????????????????????????????
        ? OnQuestCompleted.Broadcast()     ?
        ?   ?? UI обновляется:                  ?
        ?       - Quest Tracker: квест удалён      ?
     ? - Иконка над Lianne: обновлена     ?
        ?  - Notification: "Quest Complete!"  ?
        ????????????????????????????????????????????
```

---

## ?? Детали извлечения NPC ID

```
???????????????????????????????????????????????????????????????
?   BP_Lianne (NPC Actor)   ?
?   ?? GameplayTags: NPC.Lianne  ?
?   ?? Name: "BP_Lianne_C_1"           ?
?   ?? QuestGiverComponent     ?
?       ?? NpcId: (auto) "BP_Lianne_C_1"       ?
???????????????????????????????????????????????????????????????
         ?
         ?????????????????????????????????
       ? DialogueSubsystem.cpp:        ?
       ?  StartDialogue()       ?
         ?????????????????????????????????
?
    ????????????????????????????????????????????
    ? 1?? TRY: IGameplayTagAssetInterface       ?
    ?  ?? GetOwnedGameplayTags()           ?
    ?      ?? Found: NPC.Lianne  ?
    ?        ?? Extract: "Lianne" ?         ?
    ????????????????????????????????????????????
      ?
         ?????????????????????????????????
   ? IF (NpcId != NAME_None)     ?
  ?   GOTO: EmitEvent ?        ?
         ??????????????????????????????????

    ???????????????????????????????????????????
    ? 2?? FALLBACK: Actor Name Simplification  ?
    ?  ?? GetName() ? "BP_Lianne_C_1"   ?
?      ?? RemoveFromStart("BP_")         ?
    ?   ? "Lianne_C_1"      ?
    ?      ?? Left(UnderscoreIndex)    ?
    ?          ? "Lianne" ?       ?
    ???????????????????????????????????????????
         ?
         ?????????????????????????????????
? EmitDialogueEvent()           ?
   ?  StringParam = "Lianne"       ?
         ?????????????????????????????????
```

---

## ?? Сравнение NPC ID в разных местах

```
????????????????????????????????????????????????????????????????????
?        NPC ID ИСПОЛЬЗУЕТСЯ В:               ?
????????????????????????????????????????????????????????????????????
     ?       ?              ? ?
    ???????????   ???????????   ????????????  ????????????
    ?GameEvent?   ? Quest   ?   ?  Quest   ?  ? Dialogue ?
    ?  Bus    ?   ?Condition?   ?  Giver   ?  ?  Asset   ?
    ? Payload ?   ?  Data   ?   ?Component ?  ? Speaker  ?
    ???????????   ???????????   ????????????  ????????????
    ?             ?      ? ?
    ??????????????????????????????????????????????????????
    ? Значение: "Lianne"  ?
    ??????????????????????????????????????????????????????
 ? Извлечено из: GameplayTag "NPC.Lianne"             ?
    ? Тип: FName    ?
    ? Назначение: Идентификация NPC в событиях        ?
    ??????????????????????????????????????????????????????

VS

  ????????????????????????????????????????????????????
    ? QuestGiverComponent.NpcId = "BP_Lianne_C_1"      ?
    ????????????????????????????????????????????????????
  ? Извлечено из: Actor->GetName()      ?
    ? Тип: FName ?
    ? Назначение: UI логи, отладка (не для событий!)  ?
    ????????????????????????????????????????????????????
```

---

## ?? Условия квестов - Матрица проверок

```
???????????????????????????????????????????????????????????????????
?     ПРОВЕРКА УСЛОВИЯ (CheckCondition)             ?
???????????????????????????????????????????????????????????????????
          ?
    ?????????????????????????????????????????????????
    ?  [1/4] EventTag Check      ?
    ?  ????????????????????   ????????????????????  ?
    ?  ? Payload.EventTag ? = ?Condition.EventTag?  ?
    ?  ????????????????????   ????????????????????  ?
    ?  GameEvent.Dialogue.Started  ?
    ?              ?     ?
    ?? MatchesTag()             ?
    ?    ?      ?
    ?  GameEvent.Dialogue.Started ?          ?
    ?????????????????????????????????????????????????
            ? PASS
 ?????????????????????????????????????????????????
    ?  [2/4] NpcId Check (если указан)            ?
    ?  ????????????????????   ????????????????????  ?
?  ? Payload.StringPar? ==? Condition.NpcId  ?  ?
    ?  ????????????????????   ????????????????????  ?
    ?   "Lianne"     ==       "Lianne" ?        ?
    ?????????????????????????????????????????????????
          ? PASS
    ?????????????????????????????????????????????????
    ?  [3/4] ItemId Check (если указан)             ?
    ?  ????????????????????   ????????????????????  ?
    ?  ? Payload.StringPar? ==?Condition.ItemId  ?  ?
  ?  ????????????????????   ????????????????????  ?
    ?    (None in this case) ? SKIP ?    ?
    ?????????????????????????????????????????????????
     ? SKIP
    ?????????????????????????????????????????????????
    ?  [4/4] QuestId Check (если указан)            ?
    ?  ????????????????????   ????????????????????  ?
    ?  ? Payload.StringPar? ==?Condition.QuestId ??
    ?  ????????????????????   ????????????????????  ?
    ?    (None in this case) ? SKIP ?     ?
    ?????????????????????????????????????????????????
           ? SKIP
    ?????????????????????????????????????????????????
    ?  ? ALL CHECKS PASSED!        ?
    ?  ?? AddObjectiveProgress()    ?
    ?????????????????????????????????????????????????
```

---

## ??? Архитектура систем (упрощённо)

```
   ????????????????????
      ?  GameEventBus    ?
       ?   Subsystem      ?
        ?  (Global Hub)    ?
      ????????????????????
     ?
   ?????????????????????????????????????????????
         ?       ?       ?
    ????????????    ????????????     ????????????
    ?Inventory ?    ? Dialogue ?     ?  Time    ?
    ? System   ?  ?  System  ?     ?  System  ?
    ????????????    ????????????     ????????????
     ?         ?       ?
         ???????????????????????????????????
   ??
          EmitEvent()
     ??
      ???????????????????????
  ?  QuestEventBridge   ?
    ? (Event Subscriber)  ?
  ???????????????????????
    ?
          ForwardToQuestSystem()
?
     ?????????????????????????????????????
     ?QuestSubsystem         ?
     ?  ????????????????????????????     ?
  ?  ?  QuestEventBus         ?     ?
     ?  ? - OnGameEvent()  ?     ?
     ?  ? - CheckCondition()       ?  ?
     ?  ? - AddObjectiveProgress() ?  ?
     ?  ????????????????????????????     ?
 ?        ??
     ?  ????????????????????????????     ?
     ?  ?  QuestProgressManager ?     ?
     ?  ? - StartQuest()  ?     ?
     ?  ? - CompleteQuest()        ?     ?
     ?  ? - GetQuestState()    ?     ?
?  ????????????????????????????     ?
?????????????????????????????????????
```

---

**Схемы созданы для проекта Quest System v2.0** ??

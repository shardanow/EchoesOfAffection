# Time of Day System - Architecture Documentation

## System Architecture Overview

```
???????????????????????????????????????????????????????????????????????
?   GAME PROJECT      ?
?          ?
?  ??????????????????  ???????????????????  ??????????????????????  ?
?  ?  Game Mode     ??   Level BP      ?  ?   Player Controller?  ?
?  ?  - Init Time   ?  ?   - UI Setup    ?  ?   - Time Control   ?  ?
?  ??????????????????  ???????????????????  ??????????????????????  ?
?           ?        ?         ?    ?
????????????????????????????????????????????????????????????????????????
       ?      ?       ?
            ?      ?                  ?
???????????????????????????????????????????????????????????????????????
?TIME OF DAY PLUGIN            ?
?    ?
?  ?????????????????????????????????????????????????????????????     ?
?  ?    TimeOfDayUI Module                    ?     ?
?  ?  ????????????????????  ????????????????????????????????  ?     ?
?  ?  ? TimeOfDayWidget  ?  ?   TimeClockWidget          ?  ?     ?
?  ?  ? - Full Display   ?  ?   - Compact HUD        ?  ?     ?
?  ?  ? - Phase Icons    ?  ?   - Color Coding             ?  ?     ?
?  ?  ? - Progress Bar   ?  ?   - Format String    ?  ?     ?
?  ?  ????????????????????  ????????????????????????????????  ?     ?
?  ?????????????????????????????????????????????????????????????     ?
?   ?         ?
?   ? Implements ITimeOfDayListener      ?
?      ?          ?
?  ?????????????????????????????????????????????????????????????     ?
?  ?           TimeOfDayRuntime Module          ?     ?
?  ?   ?     ?
?  ?  ??????????????????????????????????????????????????????   ?     ?
?  ?  ?     TimeOfDaySubsystem (World Subsystem)       ?   ?     ?
?  ?  ?  ???????????????????????????????????????????????? ?   ? ?
?  ?  ?  ?  Core Responsibilities:     ? ?   ?     ?
?  ?  ?  ?  - Time Progression (Tick)         ? ?   ?     ?
?  ?  ?  ?  - Time Calculations           ? ?   ?     ?
?  ?  ?  ?  - Event Broadcasting           ? ?   ?     ?
?  ?  ?  ?  - Listener Management          ? ?   ?     ?
?  ?  ?  ?  - Phase/Season Tracking   ? ?   ?     ?
?  ?  ?  ???????????????????????????????????????????????? ?   ?   ?
?  ?  ? ?   ? ?
?  ?  ?  Broadcasts:     ?   ?     ?
?  ?  ?  • OnMinuteChanged      ?   ?     ?
?  ?  ?  • OnHourChanged                 ?   ?     ?
?  ?  ?  • OnDayChanged            ?   ?     ?
?  ?  ?  • OnDayPhaseChanged      ?   ?     ?
?  ?  ?  • OnSeasonChanged       ?   ?     ?
?  ?  ?  • OnYearChanged     ?   ?     ?
?  ?  ?  • OnTimeScaleChanged          ?   ?     ?
?  ?  ??????????????????????????????????????????????????????   ?     ?
?  ?  ?     ?
?  ?  ??????????????????????????????????????????????????????   ?     ?
?  ?  ?     TimeOfDayListenerComponent         ?   ?     ?
?  ?  ?  - Auto Register/Unregister        ?   ?     ?
?  ?  ?  - Selective Event Filtering       ?   ?     ?
?  ?  ?  - Blueprint Event Forwarding     ?   ?     ?
?  ???????????????????????????????????????????????????????   ?     ?
?  ?       ?     ?
?  ?  ??????????????????????????????????????????????????????   ? ?
?  ?  ?     TimeOfDayBlueprintLibrary  ?   ?     ?
?  ?  ?  - Static Helper Functions    ?   ?     ?
?  ?  ?  - Time Conversions       ?   ?     ?
?  ?  ?  - Convenience Accessors         ?   ?     ?
?  ?  ??????????????????????????????????????????????????????   ?     ?
?  ?????????????????????????????????????????????????????????????     ?
?           ?   ?
?             ? Uses        ?
??              ?
?  ?????????????????????????????????????????????????????????????     ?
?  ?          TimeOfDayCore Module         ? ?
?  ?        ?     ?
?  ?  ??????????????????????????????????????????????????????   ?     ?
?  ?  ?      Core Types & Data        ?   ?   ?
?  ?  ?           ?   ?     ?
?  ?  ?  Structs:  ??     ?
?  ?  ?  • FGameTime - Time representation           ?   ?     ?
?  ?  ?  • FDayPhaseDefinition - Phase config  ?   ?   ?
?  ?  ?  • FTimeConversionSettings - Scaling  ?   ?  ?
?  ?  ?  • FCalendarSettings - Calendar config      ?   ?  ?
?  ?  ?      ?   ?     ?
?  ?  ?  Enums:          ?   ?     ?
?  ?  ?  • ETimeOfDaySeason (Spring/Summer/Autumn/Winter) ?   ?     ?
?  ?  ?  • ETimeOfDayPhase (Night/Dawn/Day/Dusk/etc)      ?   ?     ?
?  ?  ?  • ETimeOfDayWeekday (Mon-Sun) ?   ?  ?
?  ?  ??????????????????????????????????????????????????????   ?     ?
?  ?    ?     ?
?  ?  ??????????????????????????????????????????????????????   ?     ?
?  ?  ?       Interfaces          ?   ?     ?
?  ?  ?          ?   ?     ?
?  ?  ?  • ITimeOfDayListener           ?   ?     ?
?  ?  ?    - OnMinuteChanged() ?   ?     ?
?  ?  ?    - OnHourChanged()           ?   ?     ?
?  ?  ?  - OnDayChanged()       ?   ?     ?
?  ??    - OnDayPhaseChanged() ?   ?     ?
?  ??    - OnSeasonChanged()                     ?   ?   ?
?  ?  ?- OnYearChanged()     ?   ?     ?
?  ?  ?    - OnTimeScaleChanged()        ?   ?     ?
?  ?  ?  ?   ?     ?
?  ?  ?  • ITimeOfDayManager        ?   ?     ?
?  ?  ?    - GetCurrentTime()         ? ?     ?
?  ?  ?    - SetCurrentTime()           ?   ?     ?
?  ??    - Control Methods    ?   ?     ?
?  ?  ??????????????????????????????????????????????????????   ?     ?
?  ?      ?     ?
?  ?  ??????????????????????????????????????????????????????   ?   ?
?  ??     TimeOfDaySettings (DataAsset)        ?   ?     ?
?  ?  ?  - Time Conversion Configuration?   ?     ?
?  ?  ?  - Calendar Configuration                  ?   ?     ?
?  ?  ?  - Day Phase Definitions   ?   ?     ?
?  ?  ?  - Initial Game Time          ?   ?  ?
?  ?  ??????????????????????????????????????????????????????   ?     ?
?  ?????????????????????????????????????????????????????????????     ?
?    ?
?????????????????????????????????????????????????????????????????????????

```

## Data Flow Diagram

```
???????????????????????????????????????????????????????????????????????
?          TIME PROGRESSION FLOW      ?
???????????????????????????????????????????????????????????????????????

Real Time Delta (Engine Tick)
         ?
         ?
???????????????????????????
?  TimeOfDaySubsystem     ?
?  Tick(DeltaTime)        ?
???????????????????????????
         ?
         ?
???????????????????????????????????????????
?  Convert Real ? Game Time               ?
?  GameDelta = RealDelta *            ?
?  (86400 / RealSecsPerDay) * TimeScale   ?
???????????????????????????????????????????
?
     ?
???????????????????????????
?  Update FGameTime  ?
?  - TotalElapsedSeconds  ?
?  - Hour, Minute, Second ?
?  - Day, Season, Year    ?
???????????????????????????
         ?
    ?
???????????????????????????
?  Detect Changes         ?
?  - Minute Changed?      ?
?  - Hour Changed?      ?
?  - Day Changed??
?  - Phase Changed? ?
?  - Season Changed?      ?
?  - Year Changed?     ?
???????????????????????????
         ?
     ?
???????????????????????????????????????????
?  Broadcast Events ?
?  ???????????????????????????????????   ?
?  ?  Multicast Delegates:           ?   ?
?  ?  - OnMinuteChanged.Broadcast()  ?   ?
?  ?  - OnHourChanged.Broadcast()?   ?
?  ?  - OnDayChanged.Broadcast()     ?   ?
?  ?  - OnPhaseChanged.Broadcast()   ?   ?
?  ?  - OnSeasonChanged.Broadcast()  ?   ?
?  ?  - OnYearChanged.Broadcast()    ?   ?
?  ???????????????????????????????????   ?
?         ?
?  ???????????????????????????????????   ?
?  ?  Interface Calls:     ?   ?
?  ?  For each Registered Listener:  ?   ?
?  ?  - Execute_OnMinuteChanged()    ?   ?
?  ?  - Execute_OnHourChanged()      ?   ?
?  ?  - Execute_OnDayChanged()       ?   ?
?  ?  - Execute_OnPhaseChanged()     ?   ?
?  ?  - Execute_OnSeasonChanged()    ?   ?
?  ?  - Execute_OnYearChanged()      ?   ?
?  ???????????????????????????????????   ?
???????????????????????????????????????????
         ?
    ??????????????????????????????????????????????
    ?              ?       ?     ?
       ?              ?      ?              ?
  ????????????   ????????????   ????????????   ????????????
  ? UI       ?   ? Lighting ?   ? Weather  ?   ? NPCs     ?
  ? Widgets  ?   ? System   ?   ? System   ?   ? Schedule ?
  ????????????   ????????????   ????????????   ????????????
```

## Class Hierarchy

```
UObject
??? UPrimaryDataAsset
?   ??? UTimeOfDaySettings [Core]
?
??? UBlueprintFunctionLibrary
?   ??? UTimeOfDayBlueprintLibrary [Runtime]
?
??? AActor
    ??? ATimeDebugActor [Runtime]

UActorComponent
??? UTimeOfDayListenerComponent [Runtime]
    ??? Implements: ITimeOfDayListener

UWorldSubsystem
??? UTickableWorldSubsystem
    ??? UTimeOfDaySubsystem [Runtime]
        ??? Implements: ITimeOfDayManager

UUserWidget
??? UTimeOfDayWidget [UI]
?   ??? Implements: ITimeOfDayListener
??? UTimeClockWidget [UI]
    ??? Implements: ITimeOfDayListener

UInterface
??? UTimeOfDayListener [Core]
?   ??? ITimeOfDayListener
?       ??? OnMinuteChanged()
?       ??? OnHourChanged()
?       ??? OnDayChanged()
?       ??? OnDayPhaseChanged()
???? OnSeasonChanged()
?       ??? OnYearChanged()
?       ??? OnTimeScaleChanged()
?
??? UTimeOfDayManager [Core]
    ??? ITimeOfDayManager
        ??? GetCurrentTime()
        ??? SetCurrentTime()
    ??? GetCurrentPhase()
        ??? AdvanceTime()
        ??? SetTimeScale()
        ??? PauseTime()
        ??? ResumeTime()
        ??? RegisterListener()
        ??? UnregisterListener()
```

## Event Flow Sequence

```
??????????   ????????????????   ??????????????   ?????????????
? Engine ?   ?  Subsystem   ?   ?  Listener  ?   ?  Gameplay ?
??????????   ????????????????   ??????????????   ?????????????
    ?       ?       ?   ?
    ? Tick(0.016s)  ?      ?    ?
    ???????????????>?           ?     ?
    ?        ?       ?          ?
    ?  ? UpdateTime()     ?                ?
    ?      ???????????????    ?         ?
    ?    ?   ?    ?       ?
?               ?<?????????????    ?   ?
    ?        ?               ?     ?
    ?               ? ProcessChanges() ?     ?
    ?               ???????????????    ?    ?
    ?             ? ?    ?     ?
    ?             ?<?????????????    ? ?
    ?          ?          ?  ?
    ?? OnHourChanged    ?         ?
    ?          ??????????????????>?              ?
?      ?             ?   ?
    ?        ?     ? BP Event       ?
    ?         ?       ????????????????>?
    ?   ?      ?       ?
    ? ? Broadcast Delegate     ?
 ?     ????????????????????????????????????>?
    ? ?                  ?  ?
    ?   ?      ? UpdateSchedule()?
    ?  ?      ?<????????????????
    ?       ?     ?             ?
    ?<???????????????     ?       ?
    ?          ?       ?    ?
```

## Module Dependencies

```
???????????????????????????????????????????????????????????
?                Dependency Graph  ?
???????????????????????????????????????????????????????????

????????????????????
   ?   TimeOfDayUI    ?
          ?   - Widgets ?
      ?   - Visual       ?
  ????????????????????
    ?
             ? depends on
            ?
         ???????????????????????????
         ?  TimeOfDayRuntime       ?
         ?  - Subsystems    ?
         ?  - Components           ?
     ?  - Blueprint Library    ?
     ???????????????????????????
     ?
        ? depends on
  ?
         ???????????????????????????
   ?   TimeOfDayCore         ?
         ? - Types       ?
         ?   - Interfaces  ?
         ?   - Data Assets       ?
   ???????????????????????????
        ?
       ? depends on
                  ?
         ???????????????????????????
    ?   Unreal Engine Core    ?
         ?   - CoreUObject         ?
         ?   - Engine ?
         ???????????????????????????
```

## Memory Layout

```
??????????????????????????????????????????????????????????????????
?         TimeOfDaySubsystem Memory     ?
?  Size: ~256 bytes + (Listeners * 16 bytes)          ?
??????????????????????????????????????????????????????????????????
?  FGameTime CurrentTime           [56 bytes]     ?
?  ?? int32 Year    [4]            ?
?  ?? ETimeOfDaySeason Season            [1]?
?  ?? int32 DayOfSeason        [4]            ?
?  ?? ETimeOfDayWeekday DayOfWeek       [1]       ?
?  ?? int32 Hour         [4]            ?
?  ?? int32 Minute       [4]   ?
?  ?? int32 Second     [4]            ?
?  ?? double TotalElapsedSeconds [8]      ?
?   ?
?  FTimeConversionSettings     [12 bytes]     ?
?  ?? float RealSecondsPerGameDay       [4]     ?
?  ?? float TimeScale            [4]          ?
?  ?? bool bIsPaused          [1]        ?
?    ?
?  FCalendarSettings[20 bytes]     ?
?  ?? int32 DaysPerSeason        [4]    ?
?  ?? int32 SeasonsPerYear         [4]      ?
?  ?? int32 DaysPerWeek     [4]     ?
?     ?
?  TArray<ITimeOfDayListener> Listeners      [16 + N*16]    ?
?   ?
?  Previous State Variables      [24 bytes]  ?
?  ?? int32 PreviousMinute       [4]      ?
?  ?? int32 PreviousHour           [4]        ?
?  ?? int32 PreviousDay   [4]       ?
?  ?? ETimeOfDayPhase PreviousPhase        [1]         ?
?  ?? ETimeOfDaySeason PreviousSeason         [1] ?
?  ?? int32 PreviousYear            [4]        ?
??????????????????????????????????????????????????????????????????
```

## Performance Characteristics

```
???????????????????????????????????????????????????????????????
?    Performance Profile     ?
???????????????????????????????????????????????????????????????

Subsystem Tick:
?? Time Calculation:         0.001 - 0.005 ms
?? Change Detection:         0.001 - 0.002 ms
?? Event Broadcast:   0.001 ms per listener
?? Total:            0.005 - 0.020 ms (typical)

Event Processing (per listener):
?? Interface Call:           0.001 ms
?? Blueprint Event:    0.005 - 0.020 ms
?? Native C++ Handler:      0.001 - 0.005 ms

UI Widget Update:
?? Text Update:             0.010 - 0.030 ms
?? Color Change:        0.005 - 0.010 ms
?? Progress Bar:           0.005 - 0.010 ms

Memory Footprint:
?? Subsystem:       ~256 bytes
?? Per Listener:       ~16 bytes
?? Settings Asset:           ~4 KB
?? UI Widget:         ~2 KB

Typical Load (100 listeners):
?? Memory:       ~2.5 KB
?? CPU (per frame):   0.1 - 0.5 ms
?? Events (per minute):           100 calls
```

## Design Patterns Used

```
1. Observer Pattern
   ?? ITimeOfDayListener interface for event subscription

2. Singleton Pattern (via Subsystem)
   ?? One TimeOfDaySubsystem per World

3. Strategy Pattern
   ?? Pluggable time calculation strategies

4. Facade Pattern
   ?? TimeOfDayBlueprintLibrary simplifies API access

5. Component Pattern
   ?? TimeOfDayListenerComponent for modular functionality

6. Data-Driven Design
   ?? TimeOfDaySettings DataAsset for configuration

7. Event-Driven Architecture
   ?? All updates via delegates and events

8. Interface Segregation (SOLID)
   ?? Separate ITimeOfDayListener and ITimeOfDayManager

9. Dependency Inversion (SOLID)
   ?? Depend on interfaces, not concrete implementations

10. Single Responsibility (SOLID)
    ?? Each class has one clear purpose
```

## Thread Safety

```
??????????????????????????????????????????????????????????
? Thread Safety Considerations              ?
??????????????????????????????????????????????????????????

Game Thread Only:
?? TimeOfDaySubsystem::Tick()
?? All Event Broadcasts
?? Listener Registration/Unregistration
?? UI Updates

Thread-Safe (Read-Only):
?? FGameTime::GetNormalizedTimeOfDay()
?? FGameTime::GetMinutesSinceMidnight()
?? Enum conversions

Not Thread-Safe:
?? Direct modification of CurrentTime

Recommendation:
?? All Time of Day operations should be on Game Thread
```

## Extension Points

```
????????????????????????????????????????????????????????????
?       How to Extend System    ?
????????????????????????????????????????????????????????????

1. Add Custom Event Types
   ?? Extend ITimeOfDayListener interface

2. Create Custom Subsystems
   ?? Implement ITimeOfDayListener in your subsystem

3. Add Custom Components
   ?? Create components that listen to time events

4. Extend Data Asset
   ?? Subclass TimeOfDaySettings for custom configuration

5. Create Custom Widgets
   ?? Inherit from TimeOfDayWidget or implement interface

6. Add Custom Calculations
   ?? Override TimeOfDaySubsystem methods

7. Integrate with Other Systems
   ?? Weather, AI, Quest, Audio, etc.
```

---

**Architecture Version:** 1.0  
**Last Updated:** 2024  
**Designed For:** Unreal Engine 5.6+

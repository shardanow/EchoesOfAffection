# Проблема: Dimension Bar показывает 50% при значении 0

## ?? Описание проблемы

При отображении `RelationshipDimensionBar` виджета со значением `0`, прогресс-бар **визуально заполнен на 50%** вместо ожидаемых 0%.

### Симптомы
- ? Текст показывает правильное значение: `"Trust: 0"`, `"Friendship: 0"`
- ? ProgressBar визуально заполнен наполовину
- ? Логи показывают `RawValue: 0.00`
- ? Логи показывают `NormalizedValue: 0.50`
- ? ProgressBar->SetPercent(0.50) ? **50%!**

---

## ?? Причина проблемы

### Математика нормализации

Функция `URelationshipDimension::NormalizeValue()` преобразует сырое значение в диапазон 0-1:

```cpp
float URelationshipDimension::NormalizeValue(float Value) const
{
	const float Range = MaxValue - MinValue;
	if (Range > KINDA_SMALL_NUMBER)
	{
		return (Value - MinValue) / Range;
	}
	return 0.5f;
}
```

### Текущие настройки в DataAssets

**По умолчанию** dimensions настроены с диапазоном **-100 до +100**:

```
MinValue = -100
MaxValue = 100
DefaultValue = 0
```

### Расчет нормализованного значения

При значении **0**:

```cpp
Range = MaxValue - MinValue = 100 - (-100) = 200
NormalizedValue = (Value - MinValue) / Range
       = (0 - (-100)) / 200
      = 100 / 200
       = 0.5  ? 50%!
```

**Визуальный результат:** Прогресс-бар заполнен на **50%** ? **математически правильно**, но ? **визуально запутывает**.

---

## ? Решения

### Решение 1: Изменить диапазон значений (РЕКОМЕНДУЕТСЯ)

**Самое простое и правильное решение** - изменить диапазон dimensions на **0-100** вместо **-100 до +100**.

#### Шаги:

1. Откройте DataAsset:
   - `Content/RelationshipSystem/DataAssets/DA_Dimension_Trust`
   - `Content/RelationshipSystem/DataAssets/DA_Dimension_Friendship`

2. Измените параметры:
   ```
   Min Value: 0     (было: -100)
   Max Value: 100   (без изменений)
   Default Value: 0 (без изменений)
   ```

3. Сохраните DataAssets

4. Запустите игру

#### Результат:

```cpp
Range = MaxValue - MinValue = 100 - 0 = 100
NormalizedValue = (Value - MinValue) / Range
  = (0 - 0) / 100
     = 0.0  ? 0%! ?
```

**Преимущества:**
- ? Не требует компиляции C++
- ? Мгновенное применение
- ? Интуитивно понятно (0% = минимум, 100% = максимум)
- ? Работает "из коробки"

---

### Решение 2: Отключить нормализацию

Если хотите использовать диапазон **-100 до +100**, но показывать только положительные значения:

#### Шаги:

1. Откройте Blueprint виджета `WBP_RelationshipDimensionBar`
2. В **Class Defaults** найдите параметр `bNormalizeValue`
3. Установите **False**
4. Сохраните Blueprint

#### Результат:

Код будет использовать raw значение напрямую:

```cpp
DisplayValue = FMath::Clamp(RawValue / 100.0f, 0.0f, 1.0f);
    = FMath::Clamp(0 / 100.0f, 0.0f, 1.0f)
 = 0.0  ? 0%! ?
```

**Недостатки:**
- ? Жестко задан делитель `/100.0f`
- ? Не использует настройки из DataAssets
- ?? Работает только для диапазона 0-100

---

### Решение 3: Изменить C++ код (для продвинутых пользователей)

Изменить логику отображения, чтобы показывать только положительную часть диапазона.

#### Код в `RelationshipDimensionBar.cpp`:

```cpp
void URelationshipDimensionBar::NativeRefreshDisplay()
{
	// ... existing code ...

	// Update progress bar
	if (ProgressBar)
	{
		float DisplayValue;
		
		if (bNormalizeValue)
		{
			// Показывать только положительную часть диапазона
			// Отрицательные значения = 0%, положительные = 0-100%
			DisplayValue = FMath::Max(0.0f, NormalizedValue);
		}
		else
		{
			DisplayValue = FMath::Clamp(RawValue / 100.0f, 0.0f, 1.0f);
		}
		
		ProgressBar->SetPercent(DisplayValue);
	}
	
	// ... rest of code ...
}
```

#### Результат:

При диапазоне **-100 до +100**:
- **-100** ? нормализовано в 0.0 ? `FMath::Max(0.0f, 0.0f)` = **0%**
- **0** ? нормализовано в 0.5 ? `FMath::Max(0.0f, 0.5f)` = **50%**
- **+100** ? нормализовано в 1.0 ? `FMath::Max(0.0f, 1.0f)` = **100%**

?? **ВНИМАНИЕ:** Этот код уже добавлен в проект, но **требует полной перекомпиляции C++**!

#### Шаги для применения:

1. **Закройте Unreal Editor**
2. В **Visual Studio**: `Build ? Rebuild Solution`
3. Дождитесь завершения компиляции
4. Запустите **Unreal Editor**
5. Запустите игру

**Недостатки:**
- ? Требует перекомпиляцию всего проекта
- ? Hot Reload не работает для изменений в функциях
- ?? Отображение "половины шкалы" может быть неинтуитивным

---

## ?? Рекомендация

**Используйте Решение 1** - изменение диапазона на **0-100**:

### Почему?

1. **Простота:** Не требует компиляции, работает мгновенно
2. **Понятность:** 0% = минимум, 100% = максимум
3. **Гибкость:** Все настройки в DataAssets
4. **Стандарт:** Большинство систем отношений используют 0-100

### Когда использовать -100 до +100?

Если вам **действительно нужны отрицательные значения** (например, для "враждебности"):
- **-100** = максимальная враждебность
- **0** = нейтральность
- **+100** = максимальная дружелюбность

В этом случае используйте **Решение 3** (C++ код), но помните:
- Прогресс-бар покажет **только положительную часть**
- Отрицательные значения всегда будут **0%**
- Это может быть неинтуитивно для игроков

---

## ?? Сравнение решений

| Критерий | Решение 1<br>(0-100) | Решение 2<br>(отключить) | Решение 3<br>(C++ код) |
|----------|---------------------|-------------------------|----------------------|
| **Компиляция C++** | ? Не требуется | ? Не требуется | ? Требуется |
| **Скорость применения** | ? Мгновенно | ? Мгновенно | ?? 5-10 минут |
| **Гибкость** | ? Высокая | ?? Низкая | ? Высокая |
| **Интуитивность** | ? 0%=мин, 100%=макс | ? Простая | ?? Только + часть |
| **Отрицательные значения** | ? Нет | ?? Работает странно | ? Да (скрыты) |
| **Рекомендуется** | ??? | ?? | ???? |

---

## ?? Отладка

### Проверка текущих значений

Запустите игру и откройте диалог с NPC. В логах ищите:

```
LogTemp: RelationshipDimensionBar::NativeRefreshDisplay - START
LogTemp:   DimensionTag: Relationship.Dimension.Trust
LogTemp:   RawValue: 0.00   ? Сырое значение
LogTemp:   NormalizedValue: 0.50   ? Нормализованное (0-1)
LogTemp:   ProgressBar->SetPercent(0.50)  ? Установлено в ProgressBar
```

### Что проверить:

1. **RawValue** - должно быть ваше ожидаемое значение (0, 50, 100, и т.д.)
2. **NormalizedValue** - зависит от диапазона:
   - Для **-100 до +100**: `0` ? `0.50`
   - Для **0 до 100**: `0` ? `0.00`
3. **SetPercent** - какое значение установлено в ProgressBar

---

## ?? Дополнительная информация

### Где находятся DataAssets

```
Content/
??? RelationshipSystem/
    ??? DataAssets/
        ??? DA_Dimension_Trust.uasset
        ??? DA_Dimension_Friendship.uasset
```

### Где находится Blueprint виджета

```
Content/
??? RelationshipSystem/
    ??? UI/
        ??? WBP_RelationshipDimensionBar.uasset
```

### Где находится C++ код

```
Plugins/
??? RelationshipSystem/
  ??? Source/
        ??? RelationshipSystemUI/
            ??? Public/Widgets/RelationshipDimensionBar.h
    ??? Private/Widgets/RelationshipDimensionBar.cpp
```

---

## ?? Связанные документы

- `README.md` - Общая документация плагина
- `SETUP_ISSUE.md` - Проблемы с настройкой
- `TROUBLESHOOTING.md` - Решение проблем

---

## ?? Версия документа

- **Создано:** 2 ноября 2025
- **Версия:** 1.0
- **Плагин:** RelationshipSystem v1.0
- **UE Version:** 5.6
